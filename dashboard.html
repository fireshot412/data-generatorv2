<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mimic - Data Generation Console</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --primary-light: #818CF8;
            --secondary: #764ba2;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --sidebar-width: 260px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            overflow-x: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            font-size: 28px;
            color: var(--primary);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            padding: 0 12px 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .nav-item-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-menu:hover {
            background: var(--gray-100);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .user-email {
            font-size: 11px;
            color: var(--gray-500);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
        }

        .topbar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .topbar-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
        }

        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.primary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .stat-icon.success {
            background: rgba(16, 185, 129, 0.1);
        }

        .stat-icon.warning {
            background: rgba(245, 158, 11, 0.1);
        }

        .stat-icon.error {
            background: rgba(239, 68, 68, 0.1);
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-change {
            font-size: 13px;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--error);
        }

        /* Charts */
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Jobs List */
        .jobs-grid {
            display: grid;
            gap: 16px;
        }

        .job-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
            transition: all 0.2s;
        }

        .job-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .job-card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .job-title-section {
            flex: 1;
        }

        .job-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .job-subtitle {
            font-size: 13px;
            color: var(--gray-500);
        }

        .job-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .job-status-badge.running {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .job-status-badge.paused {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .job-status-badge.stopped {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-600);
        }

        .job-status-badge.initializing {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .job-card-body {
            padding: 20px 24px;
        }

        .job-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .job-stat {
            text-align: center;
        }

        .job-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .job-stat-label {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 4px;
        }

        .job-next-activity {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-left: 3px solid var(--primary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .job-next-activity.inactive {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.03) 0%, rgba(156, 163, 175, 0.03) 100%);
            border-left: 3px solid var(--gray-400);
            opacity: 0.7;
        }

        .job-next-activity-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .job-next-activity.inactive .job-next-activity-label {
            color: var(--gray-500);
        }

        .job-next-activity-time {
            font-size: 14px;
            color: var(--gray-700);
        }

        .job-next-activity.inactive .job-next-activity-time {
            color: var(--gray-500);
        }

        .job-next-activity-note {
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 4px;
            font-style: italic;
        }

        .job-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-gray {
            background: var(--gray-500);
            color: white;
        }

        .btn-info {
            background: #3B82F6;
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 24px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--error);
        }

        .toast.info {
            border-left: 3px solid var(--primary);
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: var(--gray-900);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Form in modal */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .label-description {
            font-weight: 400;
            color: var(--gray-500);
            font-size: 12px;
            margin-top: 4px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Industry Grid */
        .industry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .industry-option {
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
        }

        .industry-option:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .industry-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        /* Configuration Mode Tabs */
        .config-mode-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gray-200);
        }

        .mode-tab {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-tab span {
            font-size: 18px;
        }

        .mode-tab:hover {
            background: var(--gray-50);
            border-color: var(--primary);
        }

        .mode-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .config-panel {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Review Panel Styles */
        .review-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
        }

        .review-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .review-card-body {
            padding: 18px;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .review-value {
            font-size: 14px;
            color: var(--gray-900);
            font-weight: 600;
            text-align: right;
            max-width: 60%;
        }

        .edit-link {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-link:hover {
            background: var(--primary);
            color: white;
        }

        /* Connection Type Badges */
        .connection-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .connection-badge.asana {
            background-color: #f06a6a;
            color: white;
        }

        .connection-badge.okta {
            background-color: #007dc1;
            color: white;
        }

        .connection-badge.salesforce {
            background-color: #00A1E0;
            color: white;
        }

        /* Connection-specific job cards */
        .job-card.asana {
            border-left: 4px solid #f06a6a;
        }

        .job-card.okta {
            border-left: 4px solid #007dc1;
        }

        .job-card.salesforce {
            border-left: 4px solid #00A1E0;
        }

        /* Connection-specific form fields */
        .asana-only, .okta-only {
            transition: opacity 0.2s, max-height 0.3s;
        }

        /* User tokens */
        .user-tokens-container {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
        }

        .user-token-item {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .user-token-item input:first-child {
            flex: 0 0 150px;
        }

        .user-token-item input:nth-child(2) {
            flex: 1;
        }

        .remove-user-btn {
            flex: 0 0 auto;
            padding: 8px 12px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        /* Activity Log */
        .activity-log {
            font-size: 13px;
        }

        .activity-item {
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            gap: 16px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            flex: 0 0 140px;
            color: var(--gray-500);
            font-size: 12px;
        }

        .activity-user {
            flex: 0 0 80px;
        }

        .activity-user-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .activity-details {
            flex: 1;
        }

        .activity-action {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .activity-description {
            color: var(--gray-700);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 220px;
            }

            .content-area {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <span class="logo-icon">‚óê</span>
                    <span class="logo-text">Mimic</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" data-view="dashboard">
                        <span class="nav-item-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a class="nav-item" data-view="jobs">
                        <span class="nav-item-icon">üöÄ</span>
                        <span>Jobs</span>
                    </a>
                    <a class="nav-item" data-view="connections">
                        <span class="nav-item-icon">üîå</span>
                        <span>Connections</span>
                    </a>
                    <a class="nav-item" data-view="settings">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Resources</div>
                    <a class="nav-item" href="/old" target="_blank">
                        <span class="nav-item-icon">üì¶</span>
                        <span>Legacy UI</span>
                    </a>
                    <a class="nav-item" href="https://docs.anthropic.com" target="_blank">
                        <span class="nav-item-icon">üìñ</span>
                        <span>Documentation</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-menu" onclick="logout()">
                    <div class="user-avatar">U</div>
                    <div class="user-info">
                        <div class="user-name">User</div>
                        <div class="user-email">Logout ‚Üí</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <h1 class="topbar-title" id="pageTitle">Dashboard</h1>
                <div class="topbar-actions" id="jobActions" style="display: none;">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        üîÑ Refresh
                    </button>
                    <button class="btn btn-primary" onclick="showNewJobModal()">
                        + New Job
                    </button>
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <!-- Content will be loaded here -->
            </div>
        </main>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:5001/api';
        let currentView = 'dashboard';
        let jobsData = [];
        let selectedIndustry = 'technology';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeNavigation();
            loadView('dashboard');

            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (currentView === 'dashboard' || currentView === 'jobs') {
                    refreshData();
                }
            }, 30000);
        });

        function initializeNavigation() {
            document.querySelectorAll('.nav-item[data-view]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = item.dataset.view;
                    loadView(view);

                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });
        }

        async function loadView(view) {
            currentView = view;
            const contentArea = document.getElementById('contentArea');
            const pageTitle = document.getElementById('pageTitle');
            const jobActions = document.getElementById('jobActions');

            // Show job actions only on jobs page
            if (view === 'jobs') {
                jobActions.style.display = 'flex';
            } else {
                jobActions.style.display = 'none';
            }

            switch(view) {
                case 'dashboard':
                    pageTitle.textContent = 'Dashboard';
                    await renderDashboard();
                    break;
                case 'jobs':
                    pageTitle.textContent = 'Jobs';
                    await renderJobs();
                    break;
                case 'connections':
                    pageTitle.textContent = 'Connections';
                    renderConnections();
                    break;
                case 'settings':
                    pageTitle.textContent = 'Settings';
                    renderSettings();
                    break;
            }
        }

        async function renderDashboard() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading dashboard...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/jobs`);
                const data = await response.json();

                if (data.success) {
                    jobsData = data.jobs;

                    // Calculate stats
                    const stats = calculateStats(jobsData);

                    contentArea.innerHTML = `
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon primary">üöÄ</div>
                                    <div>
                                        <div class="stat-label">Active Jobs</div>
                                    </div>
                                </div>
                                <div class="stat-value">${stats.activeJobs}</div>
                                <div class="stat-change">${stats.runningJobs} running, ${stats.pausedJobs} paused</div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon success">‚ö°</div>
                                    <div>
                                        <div class="stat-label">Total Activities</div>
                                    </div>
                                </div>
                                <div class="stat-value">${stats.totalActivities.toLocaleString()}</div>
                                <div class="stat-change">Actions generated by AI</div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon warning">üîå</div>
                                    <div>
                                        <div class="stat-label">Platforms</div>
                                    </div>
                                </div>
                                <div class="stat-value">${stats.platformCount}</div>
                                <div class="stat-change">${Array.from(stats.platforms).join(', ')}</div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon ${stats.totalErrors > 0 ? 'error' : 'success'}">
                                        ${stats.totalErrors > 0 ? '‚ö†Ô∏è' : '‚úÖ'}
                                    </div>
                                    <div>
                                        <div class="stat-label">System Health</div>
                                    </div>
                                </div>
                                <div class="stat-value">${stats.totalErrors}</div>
                                <div class="stat-change">${stats.totalErrors > 0 ? 'Errors detected' : 'All systems operational'}</div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Job Status Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <h3 class="chart-title">Activity Breakdown</h3>
                                    <div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Actions generated by type</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="tasksChart"></canvas>
                                </div>
                            </div>

                            <div class="chart-card">
                                <div class="chart-header">
                                    <h3 class="chart-title">Activity Over Time</h3>
                                    <div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Daily activity trend</div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="activityChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Connection Health</h3>
                                <div style="font-size: 12px; color: #6B7280; margin-top: 4px;">Status of configured connections</div>
                            </div>
                            <div id="connectionHealthContainer" style="padding: 20px;"></div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Recent Activity</h3>
                            </div>
                            <div id="recentActivityContainer"></div>
                        </div>
                    `;

                    // Render charts
                    renderStatusChart(stats);
                    renderActivityBreakdownChart(jobsData);
                    renderActivityChart(jobsData);
                    await renderConnectionHealth();
                    await renderRecentActivity();

                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Error Loading Dashboard</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }

        function calculateStats(jobs) {
            const stats = {
                activeJobs: 0,
                runningJobs: 0,
                pausedJobs: 0,
                stoppedJobs: 0,
                totalActivities: 0,
                totalApiCalls: 0,
                totalLLMCalls: 0,
                totalErrors: 0,
                platforms: new Set(),
                activityTypes: {}
            };

            jobs.forEach(job => {
                if (job.status === 'running') {
                    stats.runningJobs++;
                    stats.activeJobs++;
                } else if (job.status === 'paused') {
                    stats.pausedJobs++;
                    stats.activeJobs++;
                } else if (job.status === 'stopped') {
                    stats.stoppedJobs++;
                }

                // Count all activity types from stats (platform-agnostic)
                if (job.stats) {
                    // Count all numeric stats except errors
                    Object.keys(job.stats).forEach(key => {
                        if (key !== 'errors' && typeof job.stats[key] === 'number') {
                            stats.totalActivities += job.stats[key];
                        }
                    });

                    stats.totalErrors += (job.stats.errors || 0);
                }

                // Track platforms
                if (job.vendor) {
                    stats.platforms.add(job.vendor);
                }
            });

            stats.platformCount = stats.platforms.size;
            return stats;
        }

        function renderStatusChart(stats) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Running', 'Paused', 'Stopped'],
                    datasets: [{
                        data: [stats.runningJobs, stats.pausedJobs, stats.stoppedJobs],
                        backgroundColor: [
                            '#10B981',
                            '#F59E0B',
                            '#6B7280'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderActivityBreakdownChart(jobs) {
            const ctx = document.getElementById('tasksChart').getContext('2d');

            // Aggregate activity types across all jobs (platform-agnostic)
            let activityCounts = {};

            jobs.forEach(job => {
                if (job.stats) {
                    Object.keys(job.stats).forEach(key => {
                        if (key !== 'errors' && typeof job.stats[key] === 'number') {
                            // Convert snake_case to Title Case for labels
                            const label = key.split('_').map(word =>
                                word.charAt(0).toUpperCase() + word.slice(1)
                            ).join(' ');

                            activityCounts[label] = (activityCounts[label] || 0) + job.stats[key];
                        }
                    });
                    activityCounts['Errors'] = (activityCounts['Errors'] || 0) + (job.stats.errors || 0);
                }
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(activityCounts),
                    datasets: [{
                        label: 'Activities',
                        data: Object.values(activityCounts),
                        backgroundColor: [
                            '#6366F1',
                            '#F59E0B',
                            '#10B981',
                            '#EF4444'
                        ],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderActivityChart(jobs) {
            const ctx = document.getElementById('activityChart').getContext('2d');

            // Generate last 7 days of data
            const labels = [];
            const data = [];
            const now = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                // Simulate activity data (in real app, this would come from API)
                data.push(Math.floor(Math.random() * 50) + 10);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Activities',
                        data: data,
                        borderColor: '#6366F1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function renderRecentActivity() {
            const container = document.getElementById('recentActivityContainer');

            if (jobsData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No activity yet</div></div>';
                return;
            }

            // Get first job's activity
            try {
                const jobId = jobsData[0].job_id;
                const response = await fetch(`${API_BASE}/jobs/${jobId}/activity_log?limit=10`);
                const data = await response.json();

                if (data.success && data.activities.length > 0) {
                    let html = '<div class="activity-log">';

                    data.activities.slice(0, 10).forEach(activity => {
                        const timestamp = new Date(activity.timestamp);
                        const {action, details, user} = formatActivity(activity);

                        html += `
                            <div class="activity-item">
                                <div class="activity-time">${timestamp.toLocaleString()}</div>
                                ${user ? `
                                    <div class="activity-user">
                                        <div class="activity-user-badge">${user}</div>
                                    </div>
                                ` : ''}
                                <div class="activity-details">
                                    <div class="activity-action">${action}</div>
                                    <div class="activity-description">${details}</div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No activity yet</div></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading activity</div></div>';
            }
        }

        function formatActivity(activity) {
            const activityDetails = activity.details;
            let user = activityDetails.user || null;
            let action = '';
            let details = '';

            switch(activity.action) {
                // Asana activities
                case 'project_created':
                    action = 'üéØ Project Created';
                    details = `Created project: <strong>${activityDetails.project_name}</strong>`;
                    break;
                case 'task_created':
                    action = 'üìã Work Item Created';
                    details = `Created item: <strong>${activityDetails.task_name}</strong>`;
                    break;
                case 'comment_added':
                    action = 'üí¨ Comment Added';
                    details = `Commented on <strong>${activityDetails.task_name || 'item'}</strong>`;
                    break;
                case 'task_completed':
                    action = '‚úÖ Item Completed';
                    details = `Completed: <strong>${activityDetails.task_name || activityDetails.task_id}</strong>`;
                    break;
                case 'task_blocked':
                    action = 'üö´ Item Blocked';
                    details = `Blocked: <strong>${activityDetails.task_name || activityDetails.task_id}</strong>`;
                    break;
                case 'task_unblocked':
                    action = 'üîì Item Unblocked';
                    details = `Unblocked: <strong>${activityDetails.task_name || activityDetails.task_id}</strong>`;
                    break;

                // Okta activities
                case 'user_created':
                    action = 'üë§ User Created';
                    details = `Created user: <strong>${activityDetails.email || activityDetails.user_name}</strong>`;
                    break;
                case 'group_created':
                    action = 'üë• Group Created';
                    details = `Created group: <strong>${activityDetails.group_name}</strong>`;
                    break;
                case 'app_created':
                    action = 'üì± App Created';
                    details = `Created app: <strong>${activityDetails.app_name}</strong>`;
                    break;
                case 'user_assigned_to_app':
                    action = 'üîó App Assigned';
                    details = `Assigned <strong>${activityDetails.user_email}</strong> to app <strong>${activityDetails.app_name}</strong>`;
                    break;
                case 'user_added_to_group':
                    action = '‚ûï User Added to Group';
                    details = `Added <strong>${activityDetails.user_email}</strong> to group <strong>${activityDetails.group_name}</strong>`;
                    break;
                case 'user_activated':
                    action = '‚úì User Activated';
                    details = `Activated user: <strong>${activityDetails.email || activityDetails.user_name}</strong>`;
                    break;
                case 'user_deactivated':
                    action = '‚úó User Deactivated';
                    details = `Deactivated user: <strong>${activityDetails.email || activityDetails.user_name}</strong>`;
                    break;

                default:
                    action = activity.action.replace(/_/g, ' ').toUpperCase();
                    details = JSON.stringify(activityDetails);
            }

            return {action, details, user};
        }

        async function renderConnectionHealth() {
            const container = document.getElementById('connectionHealthContainer');
            const connections = loadConnections();

            if (connections.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6B7280; padding: 20px;">
                        <div style="font-size: 14px; margin-bottom: 12px;">No connections configured</div>
                        <button class="btn btn-primary btn-sm" onclick="document.querySelector('.nav-item[data-view=\\'connections\\']').click()">
                            Add Connection
                        </button>
                    </div>
                `;
                return;
            }

            // Build connection health display
            let html = '<div style="display: grid; gap: 12px;">';

            for (const conn of connections) {
                const platformInfo = getPlatformInfo(conn.vendor);

                // Test connection health by checking if any users have valid tokens
                // For now, we'll show "healthy" if users exist, but in production you'd validate tokens
                const isHealthy = conn.users && conn.users.length > 0;
                const statusColor = isHealthy ? '#10B981' : '#EF4444';
                const statusIcon = isHealthy ? '‚óè' : '‚óè';
                const statusText = isHealthy ? 'Connected' : 'Disconnected';

                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: #F9FAFB; border-radius: 8px; border-left: 4px solid ${statusColor};">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 8px; padding: 8px;">
                                ${platformInfo.logo ?
                                    `<img src="${platformInfo.logo}" alt="${platformInfo.name}" style="max-width: 100%; max-height: 100%;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                     <span style="display: none; font-size: 20px;">${platformInfo.fallbackIcon}</span>` :
                                    `<span style="font-size: 20px;">${platformInfo.fallbackIcon}</span>`
                                }
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 14px; color: #111827;">${conn.name}</div>
                                <div style="font-size: 12px; color: #6B7280; margin-top: 2px;">
                                    ${platformInfo.name} ‚Ä¢ ${conn.users.length} user${conn.users.length !== 1 ? 's' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: ${statusColor}; font-size: 12px;">${statusIcon}</span>
                            <span style="font-size: 13px; font-weight: 500; color: ${statusColor};">${statusText}</span>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        let currentJobFilter = 'all';

        async function renderJobs(filterType = 'all') {
            const contentArea = document.getElementById('contentArea');
            currentJobFilter = filterType;
            contentArea.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading jobs...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/jobs`);
                const data = await response.json();

                if (data.success) {
                    jobsData = data.jobs;

                    if (jobsData.length === 0) {
                        contentArea.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üöÄ</div>
                                <div class="empty-state-title">No Jobs Yet</div>
                                <div class="empty-state-text">Get started by creating your first continuous generation job</div>
                                <button class="btn btn-primary" onclick="showNewJobModal()">+ Create First Job</button>
                            </div>
                        `;
                    } else {
                        // Filter jobs by connection type
                        let filteredJobs = jobsData;
                        if (filterType !== 'all') {
                            filteredJobs = jobsData.filter(job => {
                                const connectionType = job.connection_type || job.vendor || 'asana';
                                return connectionType === filterType;
                            });
                        }

                        let html = `
                            <div style="margin-bottom: 24px; display: flex; gap: 12px; align-items: center;">
                                <span style="font-weight: 600; color: var(--gray-700);">Filter by:</span>
                                <button class="btn ${filterType === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="renderJobs('all')">
                                    All (${jobsData.length})
                                </button>
                                <button class="btn ${filterType === 'asana' ? 'btn-primary' : 'btn-secondary'}" onclick="renderJobs('asana')" style="display: flex; align-items: center; gap: 6px;">
                                    ${getPlatformLogo('asana', 18)}
                                    <span>Asana (${jobsData.filter(j => (j.connection_type || j.vendor || 'asana') === 'asana').length})</span>
                                </button>
                                <button class="btn ${filterType === 'okta' ? 'btn-primary' : 'btn-secondary'}" onclick="renderJobs('okta')" style="display: flex; align-items: center; gap: 6px;">
                                    ${getPlatformLogo('okta', 18)}
                                    <span>Okta (${jobsData.filter(j => (j.connection_type || j.vendor || 'asana') === 'okta').length})</span>
                                </button>
                                <button class="btn ${filterType === 'salesforce' ? 'btn-primary' : 'btn-secondary'}" onclick="renderJobs('salesforce')" style="display: flex; align-items: center; gap: 6px;">
                                    ${getPlatformLogo('salesforce', 18)}
                                    <span>Salesforce (${jobsData.filter(j => (j.connection_type || j.vendor || 'asana') === 'salesforce').length})</span>
                                </button>
                            </div>
                            <div class="jobs-grid">
                        `;

                        if (filteredJobs.length === 0) {
                            html += `
                                <div style="padding: 40px; text-align: center; color: var(--gray-500);">
                                    No ${filterType} jobs found
                                </div>
                            `;
                        } else {
                            filteredJobs.forEach(job => {
                                html += renderJobCard(job);
                            });
                        }

                        html += '</div>';
                        contentArea.innerHTML = html;
                    }
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Error Loading Jobs</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }

        function renderJobStats(job, connectionType) {
            if (connectionType === 'okta') {
                return `
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.users_created || 0}</div>
                        <div class="job-stat-label">Users</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.groups_created || 0}</div>
                        <div class="job-stat-label">Groups</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.apps_created || 0}</div>
                        <div class="job-stat-label">Apps</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.app_assignments_created || 0}</div>
                        <div class="job-stat-label">App Assignments</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.group_memberships_created || 0}</div>
                        <div class="job-stat-label">Group Members</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.users_activated || 0}</div>
                        <div class="job-stat-label">Activated Users</div>
                    </div>
                `;
            } else if (connectionType === 'salesforce') {
                return `
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.accounts_count || 0}</div>
                        <div class="job-stat-label">Accounts</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.contacts_count || 0}</div>
                        <div class="job-stat-label">Contacts</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.opportunities_count || 0}</div>
                        <div class="job-stat-label">Opportunities</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.leads_count || 0}</div>
                        <div class="job-stat-label">Leads</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.cases_count || 0}</div>
                        <div class="job-stat-label">Cases</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.campaigns_count || 0}</div>
                        <div class="job-stat-label">Campaigns</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.opportunities_won || 0}</div>
                        <div class="job-stat-label">Opps Won</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.opportunities_lost || 0}</div>
                        <div class="job-stat-label">Opps Lost</div>
                    </div>
                `;
            } else {
                // Default to Asana stats
                return `
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.projects_created || 0}</div>
                        <div class="job-stat-label">Projects</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.tasks_created || 0}</div>
                        <div class="job-stat-label">Tasks</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.subtasks_created || 0}</div>
                        <div class="job-stat-label">Subtasks</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.comments_added || 0}</div>
                        <div class="job-stat-label">Comments</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.tasks_completed || 0}</div>
                        <div class="job-stat-label">Completed</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.custom_fields_created || 0}</div>
                        <div class="job-stat-label">Custom Fields</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.sections_created || 0}</div>
                        <div class="job-stat-label">Sections</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.tags_created || 0}</div>
                        <div class="job-stat-label">Tags</div>
                    </div>
                    <div class="job-stat">
                        <div class="job-stat-value">${job.stats.portfolios_created || 0}</div>
                        <div class="job-stat-label">Portfolios</div>
                    </div>
                `;
            }
        }

        /**
         * Get platform logo SVG
         */
        function getPlatformLogo(platform, size = 20) {
            const logos = {
                'asana': `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="7" r="4" fill="#F06A6A"/>
                    <circle cx="6" cy="15" r="4" fill="#F06A6A"/>
                    <circle cx="18" cy="15" r="4" fill="#F06A6A"/>
                </svg>`,
                'okta': `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#007DC1"/>
                    <circle cx="12" cy="12" r="4" fill="white"/>
                </svg>`,
                'salesforce': `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.5 5.5C10.5 4.4 11.4 3.5 12.5 3.5C13.3 3.5 14 4 14.3 4.7C14.8 4.3 15.4 4 16 4C17.7 4 19 5.3 19 7C19 7.2 19 7.4 18.9 7.6C19.6 8.1 20 9 20 10C20 11.7 18.7 13 17 13H8C6.3 13 5 11.7 5 10C5 8.6 5.9 7.4 7.2 7.1C7.1 6.9 7 6.7 7 6.5C7 5.4 7.9 4.5 9 4.5C9.6 4.5 10.1 4.8 10.5 5.2V5.5Z" fill="#00A1E0"/>
                    <path d="M8 14H16C16.6 14 17 14.4 17 15V19C17 19.6 16.6 20 16 20H8C7.4 20 7 19.6 7 19V15C7 14.4 7.4 14 8 14Z" fill="#00A1E0" opacity="0.7"/>
                </svg>`
            };
            return logos[platform] || logos['asana'];
        }

        function renderJobCard(job) {
            const startedAt = new Date(job.started_at);
            const now = new Date();
            const runtimeHours = Math.floor((now - startedAt) / (1000 * 60 * 60));
            const connectionType = job.connection_type || job.vendor || 'asana';

            return `
                <div class="job-card ${connectionType}">
                    <div class="job-card-header">
                        <div class="job-title-section">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--gray-100); border-radius: 6px;">
                                    ${getPlatformLogo(connectionType, 16)}
                                    <span style="font-size: 12px; font-weight: 600; text-transform: capitalize; color: var(--gray-700);">${connectionType}</span>
                                </div>
                                <div class="job-title">${job.job_name || job.workspace_name}</div>
                            </div>
                            <div class="job-subtitle">${job.vendor || 'asana'} ‚Ä¢ ${job.industry}${job.job_name ? ' ‚Ä¢ ' + job.workspace_name : ''} ‚Ä¢ Job ID: ${job.job_id}</div>
                        </div>
                        <div class="job-status-badge ${job.status}">${job.status}</div>
                    </div>

                    <div class="job-card-body">
                        <div class="job-stats-grid">
                            ${renderJobStats(job, connectionType)}
                        </div>

                        ${job.status === 'initializing' ? `
                            <div class="job-next-activity">
                                <div class="job-next-activity-label">‚öôÔ∏è Status</div>
                                <div class="job-next-activity-time">Generating initial data...</div>
                                <div class="job-next-activity-note">This job is creating its first projects and tasks. It will transition to 'running' status once complete.</div>
                            </div>
                        ` : job.next_activity_time ? `
                            <div class="job-next-activity ${job.status === 'stopped' || job.status === 'paused' ? 'inactive' : ''}">
                                <div class="job-next-activity-label">‚è∞ Next Scheduled Activity</div>
                                ${(job.status === 'stopped' || job.status === 'paused') && new Date(job.next_activity_time) < new Date() ?
                                    '<div class="job-next-activity-time">Will run upon start</div>' :
                                    '<div class="job-next-activity-time">' + formatScheduledTime(new Date(job.next_activity_time)) + '</div>'
                                }
                                ${job.status === 'stopped' || job.status === 'paused' ?
                                    '<div class="job-next-activity-note">Job is ' + job.status + '. Start the job to resume scheduled activities.</div>'
                                    : ''}
                            </div>
                        ` : ''}

                        <div class="job-actions">
                            ${job.status === 'running' || job.status === 'paused' || job.status === 'stopped' ?
                                `<button class="btn btn-sm btn-primary" onclick="generateNow('${job.job_id}')">‚ö° Generate Now</button>` :
                                ''
                            }
                            ${job.status === 'running' || job.status === 'initializing' ?
                                `<button class="btn btn-sm btn-warning" onclick="stopJob('${job.job_id}')">‚èπ Stop</button>` :
                                (job.status === 'stopped' || job.status === 'paused') ?
                                `<button class="btn btn-sm btn-success" onclick="resumeJob('${job.job_id}')">‚ñ∂Ô∏è Start</button>` :
                                ''
                            }
                            <button class="btn btn-sm btn-info" onclick="viewActivityLog('${job.job_id}')">üìã View Log</button>
                            <button class="btn btn-sm btn-gray" onclick="deleteJob('${job.job_id}', '${job.connection_type || 'asana'}')">üóë Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            const contentArea = document.getElementById('contentArea');

            // Load saved settings
            const settings = loadSettings();

            contentArea.innerHTML = `
                <div style="max-width: 800px;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">API Configuration</h3>
                        </div>
                        <div style="padding: 0 24px 24px;">
                            <p style="color: var(--gray-600); margin-bottom: 20px;">
                                Configure your Anthropic API key for generating AI content. Workspace and user credentials are managed in the Connections page.
                            </p>

                            <form id="settingsForm" onsubmit="saveSettings(event)">
                                <div class="form-group">
                                    <label>Anthropic API Key (Claude AI)
                                        <div class="label-description">Used for generating realistic content. Get yours at console.anthropic.com</div>
                                    </label>
                                    <input type="password" id="settingsAnthropicKey"
                                           placeholder="sk-ant-api03-..."
                                           value="${settings.anthropicKey || ''}"
                                           required>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    üíæ Save Settings
                                </button>
                            </form>

                            <div style="margin-top: 24px; padding: 16px; background: var(--gray-50); border-radius: 8px; border-left: 3px solid var(--primary);">
                                <div style="font-size: 14px; color: var(--gray-700); margin-bottom: 8px;">
                                    <strong>üí° Tip:</strong> This is a BYOK (Bring Your Own Key) model
                                </div>
                                <div style="font-size: 13px; color: var(--gray-600); line-height: 1.5;">
                                    You provide your own Anthropic API key, and LLM costs are charged directly to your Anthropic account.
                                    Workspace credentials and user tokens are configured in the <a href="#" onclick="document.querySelector('.nav-item[data-view=\\'connections\\']').click(); return false;" style="color: var(--primary); text-decoration: underline;">Connections</a> page.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" style="margin-top: 24px;">
                        <div class="chart-header">
                            <h3 class="chart-title">About Mimic</h3>
                        </div>
                        <div style="padding: 0 24px 24px;">
                            <p style="color: var(--gray-600); line-height: 1.6;">
                                Mimic generates realistic Asana data with AI-powered content that simulates
                                authentic team activity. Use it to test, demo, or populate workspaces with
                                believable projects, tasks, and comments.
                            </p>
                            <div style="margin-top: 20px; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                                <div style="font-size: 13px; color: var(--gray-600);">
                                    <div style="margin-bottom: 8px;"><strong>Version:</strong> 1.0.0</div>
                                    <div style="margin-bottom: 8px;"><strong>Status:</strong> <span style="color: var(--success);">‚óè Active</span></div>
                                    <div><strong>Server:</strong> http://localhost:5001</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPlatformInfo(vendor) {
            const platforms = {
                'asana': {
                    name: 'Asana',
                    color: '#F06A6A',
                    logo: 'https://cdn.worldvectorlogo.com/logos/asana-logo.svg',
                    fallbackIcon: 'üî∫'
                },
                'okta': {
                    name: 'Okta',
                    color: '#007DC1',
                    logo: 'https://cdn.worldvectorlogo.com/logos/okta-1.svg',
                    fallbackIcon: 'üî∑'
                },
                'salesforce': {
                    name: 'Salesforce',
                    color: '#00A1E0',
                    logo: 'https://cdn.worldvectorlogo.com/logos/salesforce-2.svg',
                    fallbackIcon: '‚òÅÔ∏è'
                },
                'jira': {
                    name: 'Jira',
                    color: '#0052CC',
                    logo: 'https://cdn.worldvectorlogo.com/logos/jira-1.svg',
                    fallbackIcon: 'üî∑'
                },
                'monday': {
                    name: 'Monday.com',
                    color: '#FF3D57',
                    logo: 'https://cdn.worldvectorlogo.com/logos/monday-logo.svg',
                    fallbackIcon: 'üìÖ'
                },
                'clickup': {
                    name: 'ClickUp',
                    color: '#7B68EE',
                    logo: 'https://cdn.worldvectorlogo.com/logos/clickup-logo.svg',
                    fallbackIcon: '‚¨ÜÔ∏è'
                },
                'trello': {
                    name: 'Trello',
                    color: '#0079BF',
                    logo: 'https://cdn.worldvectorlogo.com/logos/trello.svg',
                    fallbackIcon: 'üìã'
                },
                'linear': {
                    name: 'Linear',
                    color: '#5E6AD2',
                    logo: 'https://asset.brandfetch.io/idZAyF9rlg/idm22YDjHa.svg',
                    fallbackIcon: 'üìê'
                }
            };
            return platforms[vendor] || {
                name: vendor,
                color: '#6B7280',
                logo: null,
                fallbackIcon: 'üîå'
            };
        }

        function renderConnections() {
            const contentArea = document.getElementById('contentArea');
            const connections = loadConnections();

            contentArea.innerHTML = `
                <div style="max-width: 1400px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h2 style="font-size: 20px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Your Connections</h2>
                            <p style="color: var(--gray-600); font-size: 14px;">${connections.length} connection${connections.length !== 1 ? 's' : ''} configured</p>
                        </div>
                        <button class="btn btn-primary" onclick="showAddConnectionModal()">
                            + Add Connection
                        </button>
                    </div>

                    ${connections.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîå</div>
                            <div class="empty-state-title">No Connections Yet</div>
                            <div class="empty-state-text">
                                Add your first connection to start generating data. A connection includes your workspace and user API tokens.
                            </div>
                            <button class="btn btn-primary" onclick="showAddConnectionModal()">+ Add First Connection</button>
                        </div>
                    ` : `
                        <div class="chart-card">
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--gray-200);">
                                            <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Platform</th>
                                            <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Connection Name</th>
                                            <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Tenant / Instance</th>
                                            <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Users</th>
                                            <th style="padding: 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Created</th>
                                            <th style="padding: 16px; text-align: right; font-size: 13px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${connections.map(conn => {
                                            const platformInfo = getPlatformInfo(conn.vendor);
                                            const createdDate = new Date(conn.createdAt);
                                            const formattedDate = createdDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                                            return `
                                                <tr style="border-bottom: 1px solid var(--gray-100); transition: background 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='white'">
                                                    <td style="padding: 16px;">
                                                        <div style="display: flex; align-items: center; gap: 12px;">
                                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: ${platformInfo.color}15; display: flex; align-items: center; justify-content: center; padding: 8px; overflow: hidden;">
                                                                ${platformInfo.logo ?
                                                                    `<img src="${platformInfo.logo}" alt="${platformInfo.name}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                                    <span style="display: none; font-size: 20px;">${platformInfo.fallbackIcon}</span>` :
                                                                    `<span style="font-size: 20px;">${platformInfo.fallbackIcon}</span>`
                                                                }
                                                            </div>
                                                            <div>
                                                                <div style="font-weight: 600; font-size: 14px; color: var(--gray-900);">
                                                                    ${platformInfo.name}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td style="padding: 16px;">
                                                        <div style="font-weight: 500; font-size: 14px; color: var(--gray-900);">
                                                            ${conn.name}
                                                        </div>
                                                    </td>
                                                    <td style="padding: 16px;">
                                                        <div style="font-family: monospace; font-size: 13px; color: var(--gray-600); background: var(--gray-50); padding: 4px 8px; border-radius: 4px; display: inline-block;">
                                                            ${conn.vendor === 'okta' ? conn.orgUrl : conn.vendor === 'salesforce' ? conn.instanceUrl : conn.workspaceGid}
                                                        </div>
                                                    </td>
                                                    <td style="padding: 16px;">
                                                        <div style="display: flex; align-items: center; gap: 8px;">
                                                            <div style="display: flex; margin-left: -4px;">
                                                                ${conn.users.slice(0, 3).map((user, idx) => `
                                                                    <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 11px; border: 2px solid white; margin-left: -4px; z-index: ${3 - idx};" title="${user.name}">
                                                                        ${user.name.charAt(0).toUpperCase()}
                                                                    </div>
                                                                `).join('')}
                                                            </div>
                                                            <span style="font-size: 13px; color: var(--gray-600); font-weight: 500;">
                                                                ${conn.users.length} user${conn.users.length !== 1 ? 's' : ''}
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td style="padding: 16px;">
                                                        <div style="font-size: 13px; color: var(--gray-600);">
                                                            ${formattedDate}
                                                        </div>
                                                    </td>
                                                    <td style="padding: 16px; text-align: right;">
                                                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                                            <button class="btn btn-sm btn-secondary" onclick="editConnection('${conn.id}')" title="Edit connection">
                                                                ‚úèÔ∏è
                                                            </button>
                                                            <button class="btn btn-sm" style="background: #F59E0B; color: white;" onclick="cleanTenant('${conn.id}')" title="Clean all data from ${conn.vendor === 'asana' ? 'workspace' : conn.vendor === 'okta' ? 'organization' : 'instance'}">
                                                                üßπ
                                                            </button>
                                                            <button class="btn btn-sm btn-error" onclick="deleteConnection('${conn.id}')" title="Delete connection">
                                                                üóë
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function loadConnections() {
            try {
                const connections = localStorage.getItem('mimicConnections');
                return connections ? JSON.parse(connections) : [];
            } catch {
                return [];
            }
        }

        function saveConnections(connections) {
            localStorage.setItem('mimicConnections', JSON.stringify(connections));
        }

        function showAddConnectionModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Select Platform</h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--gray-600); margin-bottom: 24px; text-align: center;">
                            Choose which platform you want to connect to
                        </p>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px;">
                            <!-- Asana Card -->
                            <div class="platform-card" onclick="showPlatformConnectionForm('asana')" style="cursor: pointer; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; transition: all 0.2s; background: white;">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #F06A6A15; border-radius: 12px; padding: 12px;">
                                    <img src="https://cdn.worldvectorlogo.com/logos/asana-logo.svg" alt="Asana" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">üéØ</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Asana</div>
                                <div style="font-size: 12px; color: var(--success); font-weight: 600;">Available</div>
                            </div>

                            <!-- Okta Card -->
                            <div class="platform-card" onclick="showPlatformConnectionForm('okta')" style="cursor: pointer; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; transition: all 0.2s; background: white;">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #007DC115; border-radius: 12px; padding: 12px;">
                                    <img src="https://cdn.worldvectorlogo.com/logos/okta-2.svg" alt="Okta" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">üîê</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Okta</div>
                                <div style="font-size: 12px; color: var(--success); font-weight: 600;">Available</div>
                            </div>

                            <!-- Salesforce Card -->
                            <div class="platform-card" onclick="showPlatformConnectionForm('salesforce')" style="cursor: pointer; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; transition: all 0.2s; background: white;">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #00A1E015; border-radius: 12px; padding: 12px;">
                                    <img src="https://cdn.worldvectorlogo.com/logos/salesforce-2.svg" alt="Salesforce" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">‚òÅÔ∏è</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Salesforce</div>
                                <div style="font-size: 12px; color: var(--success); font-weight: 600;">Available</div>
                            </div>

                            <!-- Jira Card -->
                            <div class="platform-card platform-card-disabled" style="cursor: not-allowed; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; opacity: 0.5; background: var(--gray-50);">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #0052CC15; border-radius: 12px; padding: 12px;">
                                    <img src="https://cdn.worldvectorlogo.com/logos/jira-1.svg" alt="Jira" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">üî∑</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Jira</div>
                                <div style="font-size: 12px; color: var(--gray-500); font-weight: 600;">Coming Soon</div>
                            </div>

                            <!-- Monday.com Card -->
                            <div class="platform-card platform-card-disabled" style="cursor: not-allowed; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; opacity: 0.5; background: var(--gray-50);">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #FF3D5715; border-radius: 12px; padding: 12px;">
                                    <img src="https://cdn.worldvectorlogo.com/logos/monday-logo.svg" alt="Monday.com" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">üìÖ</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Monday.com</div>
                                <div style="font-size: 12px; color: var(--gray-500); font-weight: 600;">Coming Soon</div>
                            </div>

                            <!-- ClickUp Card -->
                            <div class="platform-card platform-card-disabled" style="cursor: not-allowed; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; opacity: 0.5; background: var(--gray-50);">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #7B68EE15; border-radius: 12px; padding: 12px;">
                                    <img src="https://cdn.worldvectorlogo.com/logos/clickup-logo.svg" alt="ClickUp" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">‚¨ÜÔ∏è</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">ClickUp</div>
                                <div style="font-size: 12px; color: var(--gray-500); font-weight: 600;">Coming Soon</div>
                            </div>

                            <!-- Trello Card -->
                            <div class="platform-card platform-card-disabled" style="cursor: not-allowed; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; opacity: 0.5; background: var(--gray-50);">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #0079BF15; border-radius: 12px; padding: 12px;">
                                    <img src="https://cdn.worldvectorlogo.com/logos/trello.svg" alt="Trello" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">üìã</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Trello</div>
                                <div style="font-size: 12px; color: var(--gray-500); font-weight: 600;">Coming Soon</div>
                            </div>

                            <!-- Linear Card -->
                            <div class="platform-card platform-card-disabled" style="cursor: not-allowed; padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; text-align: center; opacity: 0.5; background: var(--gray-50);">
                                <div style="width: 64px; height: 64px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; background: #5E6AD215; border-radius: 12px; padding: 12px;">
                                    <img src="https://asset.brandfetch.io/idZAyF9rlg/idm22YDjHa.svg" alt="Linear" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span style="display: none; font-size: 40px;">üìê</span>
                                </div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">Linear</div>
                                <div style="font-size: 12px; color: var(--gray-500); font-weight: 600;">Coming Soon</div>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    .platform-card:not(.platform-card-disabled):hover {
                        border-color: var(--primary);
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
                    }
                </style>
            `;
            document.body.appendChild(modal);
        }

        function showPlatformConnectionForm(platform) {
            // Remove the catalog modal
            document.querySelector('.modal-backdrop').remove();

            // Show platform-specific form
            if (platform === 'asana') {
                showAsanaConnectionForm();
            } else if (platform === 'okta') {
                showOktaConnectionForm();
            } else if (platform === 'salesforce') {
                showSalesforceConnectionForm();
            }
            // Add more platforms here in the future
        }

        function showAsanaConnectionForm() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">
                            <span style="font-size: 24px; margin-right: 8px;">üéØ</span>
                            Connect Asana Workspace
                        </h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="connectionForm" onsubmit="saveConnection(event, 'asana')">
                            <div class="form-group">
                                <label>Connection Name
                                    <div class="label-description">A friendly name to identify this workspace</div>
                                </label>
                                <input type="text" id="connName" placeholder="e.g. Production Workspace" required>
                            </div>

                            <div class="form-group">
                                <label>Workspace GID
                                    <div class="label-description">Find in URL: app.asana.com/0/{WORKSPACE_GID}/...</div>
                                </label>
                                <input type="text" id="connWorkspaceGid" placeholder="1234567890" required>
                            </div>

                            <div class="form-group">
                                <label>User API Tokens
                                    <div class="label-description">Add 2-3+ user tokens for multi-user simulation. Get tokens at app.asana.com/0/my-apps</div>
                                </label>
                                <div class="user-tokens-container" id="connUserTokensContainer">
                                    <div class="user-token-item">
                                        <input type="text" placeholder="User name (e.g. Alice)" class="conn-user-name" required>
                                        <input type="password" placeholder="Asana Personal Access Token" class="conn-user-token" required>
                                        <button type="button" class="remove-user-btn" onclick="removeConnUserToken(this)">√ó</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="addConnUserToken()">+ Add Another User</button>
                            </div>

                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="this.closest('.modal-backdrop').remove(); showAddConnectionModal();">
                                    ‚Üê Back
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 2;">
                                    üíæ Save Connection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showOktaConnectionForm() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">
                            <span style="font-size: 24px; margin-right: 8px;">üîê</span>
                            Connect Okta Organization
                        </h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="connectionForm" onsubmit="saveConnection(event, 'okta')">
                            <div class="form-group">
                                <label>Connection Name
                                    <div class="label-description">A friendly name to identify this Okta organization</div>
                                </label>
                                <input type="text" id="connName" placeholder="e.g. Production Okta Org" required>
                            </div>

                            <div class="form-group">
                                <label>Okta Organization URL
                                    <div class="label-description">Your Okta domain (e.g. https://dev-12345.okta.com)</div>
                                </label>
                                <input type="url" id="connOrgUrl" placeholder="https://dev-12345.okta.com" required>
                            </div>

                            <div class="form-group">
                                <label>Admin API Tokens
                                    <div class="label-description">Add 1+ admin API tokens for multi-user simulation. Get tokens at Security ‚Üí API ‚Üí Tokens</div>
                                </label>
                                <div class="user-tokens-container" id="connUserTokensContainer">
                                    <div class="user-token-item">
                                        <input type="text" placeholder="Admin name (e.g. Admin1)" class="conn-user-name" required>
                                        <input type="password" placeholder="Okta API Token (SSWS)" class="conn-user-token" required>
                                        <button type="button" class="remove-user-btn" onclick="removeConnUserToken(this)">√ó</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="addConnUserToken()">+ Add Another Admin</button>
                            </div>

                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="this.closest('.modal-backdrop').remove(); showAddConnectionModal();">
                                    ‚Üê Back
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 2;">
                                    üíæ Save Connection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showSalesforceConnectionForm() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">
                            <span style="font-size: 24px; margin-right: 8px;">‚òÅÔ∏è</span>
                            Connect Salesforce Org
                        </h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="connectionForm" onsubmit="saveConnection(event, 'salesforce')">
                            <div class="form-group">
                                <label>Connection Name
                                    <div class="label-description">A friendly name to identify this Salesforce org</div>
                                </label>
                                <input type="text" id="connName" placeholder="e.g. Production Salesforce" required>
                            </div>

                            <div class="form-group">
                                <label>Instance URL
                                    <div class="label-description">Your Salesforce instance URL (e.g. https://mycompany.my.salesforce.com)</div>
                                </label>
                                <input type="url" id="connInstanceUrl" placeholder="https://mycompany.my.salesforce.com" required>
                            </div>

                            <div class="form-group">
                                <label>User Credentials
                                    <div class="label-description">Add 1+ user credentials for multi-user simulation. Each user needs username, password, and security token</div>
                                </label>
                                <div class="user-tokens-container" id="connUserTokensContainer">
                                    <div class="user-token-item" style="display: grid; gap: 8px;">
                                        <input type="text" placeholder="Display name (e.g. Admin User)" class="conn-user-name" required>
                                        <input type="email" placeholder="Salesforce username (email)" class="conn-user-email" required>
                                        <input type="password" placeholder="Password" class="conn-user-password" required>
                                        <input type="password" placeholder="Security Token" class="conn-user-token" required>
                                        <button type="button" class="remove-user-btn" onclick="removeConnUserToken(this)" style="grid-column: 1 / -1;">Remove User</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="addSalesforceUser()">+ Add Another User</button>
                            </div>

                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="this.closest('.modal-backdrop').remove(); showAddConnectionModal();">
                                    ‚Üê Back
                                </button>
                                <button type="submit" class="btn btn-primary" style="flex: 2;">
                                    üíæ Save Connection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addSalesforceUser() {
            const container = document.getElementById('connUserTokensContainer');
            const newItem = document.createElement('div');
            newItem.className = 'user-token-item';
            newItem.style.cssText = 'display: grid; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);';
            newItem.innerHTML = `
                <input type="text" placeholder="Display name (e.g. Sales User)" class="conn-user-name" required>
                <input type="email" placeholder="Salesforce username (email)" class="conn-user-email" required>
                <input type="password" placeholder="Password" class="conn-user-password" required>
                <input type="password" placeholder="Security Token" class="conn-user-token" required>
                <button type="button" class="remove-user-btn" onclick="removeConnUserToken(this)" style="grid-column: 1 / -1;">Remove User</button>
            `;
            container.appendChild(newItem);
        }

        function addConnUserToken() {
            const container = document.getElementById('connUserTokensContainer');
            const newItem = document.createElement('div');
            newItem.className = 'user-token-item';
            newItem.innerHTML = `
                <input type="text" placeholder="User name (e.g. Bob)" class="conn-user-name" required>
                <input type="password" placeholder="Asana Personal Access Token" class="conn-user-token" required>
                <button type="button" class="remove-user-btn" onclick="removeConnUserToken(this)">√ó</button>
            `;
            container.appendChild(newItem);
        }

        function removeConnUserToken(button) {
            const container = document.getElementById('connUserTokensContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showToast('You must have at least one user token', 'error');
            }
        }

        function saveConnection(e, vendor) {
            e.preventDefault();

            const name = document.getElementById('connName').value.trim();

            // Build connection object based on vendor
            const newConnection = {
                id: Date.now().toString(),
                name,
                vendor: vendor || 'asana', // Default to asana
                createdAt: new Date().toISOString()
            };

            // Add vendor-specific fields
            if (vendor === 'okta') {
                const orgUrl = document.getElementById('connOrgUrl').value.trim();
                newConnection.orgUrl = orgUrl;
            } else if (vendor === 'salesforce') {
                const instanceUrl = document.getElementById('connInstanceUrl').value.trim();
                newConnection.instanceUrl = instanceUrl;
            } else {
                // Asana or other platforms
                const workspaceGid = document.getElementById('connWorkspaceGid').value.trim();
                newConnection.workspaceGid = workspaceGid;
            }

            // Gather users with platform-specific structure
            const users = [];
            document.querySelectorAll('#connUserTokensContainer .user-token-item').forEach(item => {
                const userName = item.querySelector('.conn-user-name').value.trim();

                if (vendor === 'salesforce') {
                    // Salesforce requires username, password, and security token
                    const userEmail = item.querySelector('.conn-user-email')?.value.trim();
                    const userPassword = item.querySelector('.conn-user-password')?.value.trim();
                    const securityToken = item.querySelector('.conn-user-token')?.value.trim();
                    if (userName && userEmail && userPassword && securityToken) {
                        users.push({
                            name: userName,
                            username: userEmail,
                            password: userPassword,
                            security_token: securityToken,
                            instance_url: newConnection.instanceUrl
                        });
                    }
                } else {
                    const userToken = item.querySelector('.conn-user-token').value.trim();
                    if (userName && userToken) {
                        if (vendor === 'okta') {
                            // Okta requires org_url in each token entry
                            users.push({
                                name: userName,
                                token: userToken,
                                org_url: newConnection.orgUrl
                            });
                        } else {
                            users.push({ name: userName, token: userToken });
                        }
                    }
                }
            });

            if (users.length === 0) {
                showToast('Please add at least one user with an API token', 'error');
                return;
            }

            newConnection.users = users;

            // Load connections and add new one
            const connections = loadConnections();
            connections.push(newConnection);
            saveConnections(connections);

            showToast('Connection saved successfully!', 'success');
            document.querySelector('.modal-backdrop').remove();
            renderConnections();
        }

        function editConnection(connectionId) {
            const connections = loadConnections();
            const connection = connections.find(c => c.id === connectionId);

            if (!connection) {
                showToast('Connection not found', 'error');
                return;
            }

            // Build platform-specific fields based on vendor
            let platformSpecificField = '';
            let userFieldsHTML = '';

            if (connection.vendor === 'okta') {
                platformSpecificField = `
                    <div class="form-group">
                        <label>Okta Organization URL
                            <div class="label-description">Your Okta domain (e.g. https://dev-12345.okta.com)</div>
                        </label>
                        <input type="url" id="editConnOrgUrl" value="${connection.orgUrl || ''}" required>
                    </div>
                `;
                userFieldsHTML = connection.users.map(user => `
                    <div class="user-token-item">
                        <input type="text" placeholder="Admin name" class="edit-conn-user-name" value="${user.name}" required>
                        <input type="password" placeholder="Okta API Token (SSWS)" class="edit-conn-user-token" value="${user.token}" required>
                        <button type="button" class="remove-user-btn" onclick="removeEditConnUserToken(this)">√ó</button>
                    </div>
                `).join('');
            } else if (connection.vendor === 'salesforce') {
                platformSpecificField = `
                    <div class="form-group">
                        <label>Instance URL
                            <div class="label-description">Your Salesforce instance URL (e.g. https://mycompany.my.salesforce.com)</div>
                        </label>
                        <input type="url" id="editConnInstanceUrl" value="${connection.instanceUrl || ''}" required>
                    </div>
                `;
                userFieldsHTML = connection.users.map(user => `
                    <div class="user-token-item" style="display: grid; gap: 8px;">
                        <input type="text" placeholder="Display name" class="edit-conn-user-name" value="${user.name}" required>
                        <input type="email" placeholder="Salesforce username (email)" class="edit-conn-user-email" value="${user.username || ''}" required>
                        <input type="password" placeholder="Password" class="edit-conn-user-password" value="${user.password || ''}" required>
                        <input type="password" placeholder="Security Token" class="edit-conn-user-token" value="${user.security_token || ''}" required>
                        <button type="button" class="remove-user-btn" onclick="removeEditConnUserToken(this)" style="grid-column: 1 / -1;">Remove User</button>
                    </div>
                `).join('');
            } else {
                // Asana
                platformSpecificField = `
                    <div class="form-group">
                        <label>Workspace GID
                            <div class="label-description">Find in URL: app.asana.com/0/{WORKSPACE_GID}/...</div>
                        </label>
                        <input type="text" id="editConnWorkspaceGid" value="${connection.workspaceGid || ''}" required>
                    </div>
                `;
                userFieldsHTML = connection.users.map(user => `
                    <div class="user-token-item">
                        <input type="text" placeholder="User name" class="edit-conn-user-name" value="${user.name}" required>
                        <input type="password" placeholder="Asana Personal Access Token" class="edit-conn-user-token" value="${user.token}" required>
                        <button type="button" class="remove-user-btn" onclick="removeEditConnUserToken(this)">√ó</button>
                    </div>
                `).join('');
            }

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Edit Connection</h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="editConnectionForm" onsubmit="updateConnection(event, '${connectionId}')">
                            <div class="form-group">
                                <label>Connection Name
                                    <div class="label-description">A friendly name to identify this connection</div>
                                </label>
                                <input type="text" id="editConnName" value="${connection.name}" required>
                            </div>

                            <div class="form-group">
                                <label>SaaS Platform
                                    <div class="label-description">Select which platform this connection is for</div>
                                </label>
                                <select id="editConnVendor" onchange="handleEditVendorChange('${connectionId}')">
                                    <option value="asana" ${connection.vendor === 'asana' ? 'selected' : ''}>Asana</option>
                                    <option value="okta" ${connection.vendor === 'okta' ? 'selected' : ''}>Okta</option>
                                    <option value="salesforce" ${connection.vendor === 'salesforce' ? 'selected' : ''}>Salesforce</option>
                                    <option value="jira" disabled>Jira (Coming Soon)</option>
                                    <option value="monday" disabled>Monday.com (Coming Soon)</option>
                                    <option value="clickup" disabled>ClickUp (Coming Soon)</option>
                                    <option value="trello" disabled>Trello (Coming Soon)</option>
                                </select>
                            </div>

                            ${platformSpecificField}

                            <div class="form-group">
                                <label>User ${connection.vendor === 'okta' ? 'Admin API Tokens' : connection.vendor === 'salesforce' ? 'Credentials' : 'API Tokens'}
                                    <div class="label-description">${connection.vendor === 'salesforce' ? 'Add 1+ user credentials for multi-user simulation' : 'Add 2-3+ user tokens for multi-user simulation'}</div>
                                </label>
                                <div class="user-tokens-container" id="editConnUserTokensContainer">
                                    ${userFieldsHTML}
                                </div>
                                <button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="addEditConnUserToken('${connection.vendor}')">+ Add Another ${connection.vendor === 'salesforce' ? 'User' : connection.vendor === 'okta' ? 'Admin' : 'User'}</button>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                                üíæ Update Connection
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addEditConnUserToken(vendor) {
            const container = document.getElementById('editConnUserTokensContainer');
            const newItem = document.createElement('div');
            newItem.className = 'user-token-item';

            if (vendor === 'salesforce') {
                newItem.style.cssText = 'display: grid; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);';
                newItem.innerHTML = `
                    <input type="text" placeholder="Display name" class="edit-conn-user-name" required>
                    <input type="email" placeholder="Salesforce username (email)" class="edit-conn-user-email" required>
                    <input type="password" placeholder="Password" class="edit-conn-user-password" required>
                    <input type="password" placeholder="Security Token" class="edit-conn-user-token" required>
                    <button type="button" class="remove-user-btn" onclick="removeEditConnUserToken(this)" style="grid-column: 1 / -1;">Remove User</button>
                `;
            } else if (vendor === 'okta') {
                newItem.innerHTML = `
                    <input type="text" placeholder="Admin name" class="edit-conn-user-name" required>
                    <input type="password" placeholder="Okta API Token (SSWS)" class="edit-conn-user-token" required>
                    <button type="button" class="remove-user-btn" onclick="removeEditConnUserToken(this)">√ó</button>
                `;
            } else {
                // Asana
                newItem.innerHTML = `
                    <input type="text" placeholder="User name" class="edit-conn-user-name" required>
                    <input type="password" placeholder="Asana Personal Access Token" class="edit-conn-user-token" required>
                    <button type="button" class="remove-user-btn" onclick="removeEditConnUserToken(this)">√ó</button>
                `;
            }
            container.appendChild(newItem);
        }

        function removeEditConnUserToken(button) {
            const container = document.getElementById('editConnUserTokensContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showToast('You must have at least one user token', 'error');
            }
        }

        function updateConnection(e, connectionId) {
            e.preventDefault();

            const name = document.getElementById('editConnName').value.trim();
            const vendor = document.getElementById('editConnVendor').value;

            // Get platform-specific fields
            const updatedConnection = {
                name,
                vendor,
                updatedAt: new Date().toISOString()
            };

            // Add vendor-specific fields
            if (vendor === 'okta') {
                const orgUrl = document.getElementById('editConnOrgUrl')?.value.trim();
                if (orgUrl) updatedConnection.orgUrl = orgUrl;
            } else if (vendor === 'salesforce') {
                const instanceUrl = document.getElementById('editConnInstanceUrl')?.value.trim();
                if (instanceUrl) updatedConnection.instanceUrl = instanceUrl;
            } else {
                // Asana
                const workspaceGid = document.getElementById('editConnWorkspaceGid')?.value.trim();
                if (workspaceGid) updatedConnection.workspaceGid = workspaceGid;
            }

            // Gather users with platform-specific structure
            const users = [];
            document.querySelectorAll('#editConnUserTokensContainer .user-token-item').forEach(item => {
                const userName = item.querySelector('.edit-conn-user-name').value.trim();

                if (vendor === 'salesforce') {
                    // Salesforce requires username, password, and security token
                    const userEmail = item.querySelector('.edit-conn-user-email')?.value.trim();
                    const userPassword = item.querySelector('.edit-conn-user-password')?.value.trim();
                    const securityToken = item.querySelector('.edit-conn-user-token')?.value.trim();
                    if (userName && userEmail && userPassword && securityToken) {
                        users.push({
                            name: userName,
                            username: userEmail,
                            password: userPassword,
                            security_token: securityToken,
                            instance_url: updatedConnection.instanceUrl
                        });
                    }
                } else {
                    const userToken = item.querySelector('.edit-conn-user-token')?.value.trim();
                    if (userName && userToken) {
                        if (vendor === 'okta') {
                            // Okta requires org_url in each token entry
                            users.push({
                                name: userName,
                                token: userToken,
                                org_url: updatedConnection.orgUrl
                            });
                        } else {
                            users.push({ name: userName, token: userToken });
                        }
                    }
                }
            });

            if (users.length === 0) {
                showToast('Please add at least one user with credentials', 'error');
                return;
            }

            updatedConnection.users = users;

            // Update connection
            const connections = loadConnections();
            const index = connections.findIndex(c => c.id === connectionId);

            if (index !== -1) {
                connections[index] = {
                    ...connections[index],
                    ...updatedConnection
                };

                saveConnections(connections);
                showToast('Connection updated successfully!', 'success');
                document.querySelector('.modal-backdrop').remove();
                renderConnections();
            } else {
                showToast('Connection not found', 'error');
            }
        }

        function handleEditVendorChange(connectionId) {
            // Close the modal and reopen with the new vendor
            const name = document.getElementById('editConnName').value;
            const newVendor = document.getElementById('editConnVendor').value;

            // Get existing connection to preserve data
            const connections = loadConnections();
            const connection = connections.find(c => c.id === connectionId);

            if (!connection) return;

            // Update the vendor temporarily and reopen
            connection.vendor = newVendor;

            document.querySelector('.modal-backdrop').remove();
            editConnection(connectionId);

            // Restore the name that was being edited
            setTimeout(() => {
                document.getElementById('editConnName').value = name;
            }, 10);
        }

        function deleteConnection(connectionId) {
            if (!confirm('Delete this connection? This will not affect any running jobs.')) {
                return;
            }

            const connections = loadConnections();
            const filtered = connections.filter(c => c.id !== connectionId);

            saveConnections(filtered);
            showToast('Connection deleted', 'success');
            renderConnections();
        }

        async function cleanTenant(connectionId) {
            const connections = loadConnections();
            const connection = connections.find(c => c.id === connectionId);

            if (!connection) {
                showToast('Connection not found', 'error');
                return;
            }

            const vendor = connection.vendor || 'asana';
            const platformInfo = getPlatformInfo(vendor);

            // Determine tenant type and value
            let tenantLabel, tenantValue, warningText;
            if (vendor === 'asana') {
                tenantLabel = 'Workspace';
                tenantValue = connection.workspaceGid;
                warningText = 'all projects, tasks, subtasks, portfolios, custom fields, and tags';
            } else if (vendor === 'okta') {
                tenantLabel = 'Organization';
                tenantValue = connection.orgUrl;
                warningText = 'all users, groups, and applications';
            } else if (vendor === 'salesforce') {
                tenantLabel = 'Instance';
                tenantValue = connection.instanceUrl;
                warningText = 'all accounts, opportunities, contacts, leads, and cases';
            }

            // Show confirmation modal
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Clean ${platformInfo.name} ${tenantLabel}</h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px; align-items: start;">
                                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                                <div>
                                    <div style="font-weight: 600; color: #92400E; margin-bottom: 4px;">Warning: This action cannot be undone</div>
                                    <div style="color: #92400E; font-size: 14px; line-height: 1.5;">
                                        This will <strong>permanently delete</strong> ${warningText} created by your jobs in this ${tenantLabel.toLowerCase()}.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--gray-900);">${tenantLabel}: ${connection.name}</div>
                            <div style="font-family: monospace; font-size: 13px; color: var(--gray-600); background: var(--gray-50); padding: 8px; border-radius: 4px;">
                                ${tenantValue}
                            </div>
                        </div>

                        <div id="cleanupProgress" style="display: none; margin-top: 20px;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: var(--gray-900);">Cleaning ${tenantLabel.toLowerCase()}...</div>
                            <div style="background: var(--gray-100); border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 12px;">
                                <div id="cleanupProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="cleanupStatus" style="font-size: 13px; color: var(--gray-600);"></div>
                        </div>

                        <div id="cleanupResult" style="display: none; margin-top: 20px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-backdrop').remove()">Cancel</button>
                        <button id="confirmCleanupBtn" class="btn btn-error" onclick="executeCleanup('${connectionId}')">Clean ${tenantLabel}</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function executeCleanup(connectionId) {
            const modal = document.querySelector('.modal-backdrop');
            const confirmBtn = document.getElementById('confirmCleanupBtn');
            const cancelBtn = modal.querySelector('.btn-secondary');
            const progressDiv = document.getElementById('cleanupProgress');
            const resultDiv = document.getElementById('cleanupResult');
            const statusDiv = document.getElementById('cleanupStatus');
            const progressBar = document.getElementById('cleanupProgressBar');

            // Disable buttons and show progress
            confirmBtn.disabled = true;
            cancelBtn.disabled = true;
            confirmBtn.textContent = 'Cleaning...';
            progressDiv.style.display = 'block';

            try {
                const connections = loadConnections();
                const connection = connections.find(c => c.id === connectionId);
                const vendor = connection.vendor || 'asana';

                // Determine tenant identifier and endpoint
                let tenantId, cleanupEndpoint, tenantLabel;
                if (vendor === 'asana') {
                    tenantId = connection.workspaceGid;
                    cleanupEndpoint = `/workspace/${tenantId}/cleanup`;
                    tenantLabel = 'workspace';
                } else if (vendor === 'okta') {
                    tenantId = connection.orgUrl;
                    cleanupEndpoint = `/okta/cleanup`;
                    tenantLabel = 'organization';
                } else if (vendor === 'salesforce') {
                    tenantId = connection.instanceUrl;
                    cleanupEndpoint = `/salesforce/cleanup`;
                    tenantLabel = 'instance';
                }

                // Phase 1: Discovering objects
                statusDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">Phase 1: Discovering ${tenantLabel} objects...</div>
                    <div style="color: var(--gray-500);">Querying ${vendor.charAt(0).toUpperCase() + vendor.slice(1)} API for all objects</div>
                `;
                progressBar.style.width = '10%';

                // Call cleanup endpoint
                const cleanupResponse = await fetch(`${API_BASE}${cleanupEndpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        user_tokens: connection.users,
                        vendor: vendor
                    })
                });

                // Update to deletion phase
                statusDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">Phase 2: Deleting objects...</div>
                    <div style="color: var(--gray-500);">Processing deletion for all discovered objects</div>
                `;
                progressBar.style.width = '50%';

                const cleanupData = await cleanupResponse.json();

                if (!cleanupData.success) {
                    throw new Error(cleanupData.error || 'Cleanup failed');
                }

                // Completion
                progressBar.style.width = '100%';

                // Build deleted objects list dynamically
                let deletedObjectsList = '';
                Object.keys(cleanupData).forEach(key => {
                    if (key.startsWith('deleted_') && typeof cleanupData[key] === 'number') {
                        const objectType = key.replace('deleted_', '').split('_').map(word =>
                            word.charAt(0).toUpperCase() + word.slice(1)
                        ).join(' ');
                        const count = cleanupData[key];
                        if (count > 0) {
                            deletedObjectsList += `<div>‚Ä¢ ${count} ${objectType.toLowerCase()}${count !== 1 ? 's' : ''}</div>`;
                        }
                    }
                });

                // Show success result with detailed breakdown
                progressDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div style="background: var(--success-bg); border: 1px solid var(--success); border-radius: 8px; padding: 16px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <span style="font-size: 24px;">‚úÖ</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--success-dark); margin-bottom: 12px;">${tenantLabel.charAt(0).toUpperCase() + tenantLabel.slice(1)} cleaned successfully!</div>
                                <div style="color: var(--success-dark); font-size: 14px; line-height: 1.8;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">Deleted Objects:</div>
                                    ${deletedObjectsList || '<div>‚Ä¢ No objects found to delete</div>'}
                                </div>
                                ${cleanupData.failed_items && cleanupData.failed_items.length > 0 ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--success);">
                                        <div style="font-weight: 600; color: #D97706; margin-bottom: 4px;">‚ö†Ô∏è ${cleanupData.failed_items.length} item(s) could not be deleted</div>
                                        <div style="color: var(--gray-600); font-size: 13px;">Some items may have permission restrictions</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                confirmBtn.style.display = 'none';
                cancelBtn.textContent = 'Close';
                cancelBtn.disabled = false;

                showToast(`${tenantLabel.charAt(0).toUpperCase() + tenantLabel.slice(1)} cleaned successfully`, 'success');

            } catch (error) {
                progressDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div style="background: #FEE; border: 1px solid var(--error); border-radius: 8px; padding: 16px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <span style="font-size: 24px;">‚ùå</span>
                            <div>
                                <div style="font-weight: 600; color: var(--error); margin-bottom: 4px;">Cleanup failed</div>
                                <div style="color: var(--error); font-size: 14px;">${error.message}</div>
                            </div>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Clean Workspace';
                cancelBtn.disabled = false;

                showToast(`Cleanup failed: ${error.message}`, 'error');
            }
        }

        function loadSettings() {
            try {
                const settings = localStorage.getItem('mimicSettings');
                return settings ? JSON.parse(settings) : {};
            } catch {
                return {};
            }
        }

        function saveSettings(e) {
            e.preventDefault();

            const settings = {
                anthropicKey: document.getElementById('settingsAnthropicKey').value.trim()
            };

            localStorage.setItem('mimicSettings', JSON.stringify(settings));
            showToast('Settings saved successfully!', 'success');
        }

        async function refreshData() {
            await loadView(currentView);
            showToast('Data refreshed', 'success');
        }

        function showNewJobModal() {
            // Check if there are any connections
            const connections = loadConnections();
            if (connections.length === 0) {
                showToast('Please add a connection first', 'error');
                // Navigate to connections
                document.querySelector('.nav-item[data-view="connections"]').click();
                return;
            }

            // Check if Anthropic API key is configured
            const settings = loadSettings();
            if (!settings.anthropicKey) {
                showToast('Please configure your Anthropic API key in Settings first', 'error');
                // Navigate to settings
                document.querySelector('.nav-item[data-view="settings"]').click();
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Create New Job</h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="newJobForm" onsubmit="createJob(event)">
                            <div class="form-group">
                                <label>Connection
                                    <div class="label-description">Select which workspace connection to use</div>
                                </label>
                                <select id="connectionSelect" required onchange="updateConnectionInfo()">
                                    <option value="">-- Select a connection --</option>
                                    ${connections.map(conn => `
                                        <option value="${conn.id}">${conn.name} (${conn.vendor.charAt(0).toUpperCase() + conn.vendor.slice(1)} - ${conn.users.length} users)</option>
                                    `).join('')}
                                </select>
                                <div id="connectionInfo" style="display: none; margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 13px; color: var(--gray-700);">
                                    <!-- Connection details will appear here -->
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="jobName">Job Name
                                    <div class="label-description">Give this job a friendly name for easy identification</div>
                                </label>
                                <input
                                    type="text"
                                    id="jobName"
                                    placeholder="e.g., Q4 Product Launch Demo, Healthcare Migration Test"
                                    maxlength="100"
                                />
                            </div>

                            <!-- CONFIGURATION MODE TABS -->
                            <div class="config-mode-tabs">
                                <button type="button" class="mode-tab active" onclick="switchConfigMode(event, 'ai')">
                                    <span>‚ö°</span> AI-Powered
                                </button>
                                <button type="button" class="mode-tab" onclick="switchConfigMode(event, 'quick')">
                                    <span>üéØ</span> Quick Setup
                                </button>
                                <button type="button" class="mode-tab" onclick="switchConfigMode(event, 'advanced')">
                                    <span>‚öôÔ∏è</span> Advanced
                                </button>
                            </div>

                            <!-- AI-POWERED MODE PANEL -->
                            <div id="aiModePanel" class="config-panel" style="display: block;">
                                <!-- PROSPECT CONTEXT SECTION -->
                            <div class="form-group">
                                <label for="prospectContext">Prospect Context
                                    <span style="color: var(--gray-500); font-weight: 400; font-size: 13px;">(Optional but Recommended)</span>
                                    <div class="label-description" id="prospectContextLabel">
                                        Tell us about your prospect: company size, industry, key challenges, etc.
                                    </div>
                                </label>
                                <textarea
                                    id="prospectContext"
                                    rows="4"
                                    placeholder="e.g., Mid-size healthcare provider with 500 employees, managing complex patient care workflows across 3 hospital locations. Heavy regulatory compliance requirements and need for cross-departmental collaboration."
                                    style="width: 100%; padding: 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                                ></textarea>
                                <div style="margin-top: 8px; display: flex; gap: 12px;">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="analyzeProspectContext()" id="analyzeBtn">
                                        ‚ú® Analyze & Get Recommendations
                                    </button>
                                    <button type="button" class="btn btn-sm btn-gray" onclick="skipProspectContext()" id="skipBtn">
                                        Skip This Step
                                    </button>
                                </div>

                                <!-- Recommendations Display (initially hidden) -->
                                <div id="prospectRecommendations" style="display: none; margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <span style="font-size: 24px;">üí°</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px;">Smart Recommendations</div>
                                            <div style="font-size: 13px; opacity: 0.9;">Based on your prospect context</div>
                                        </div>
                                    </div>

                                    <!-- Extracted Insights -->
                                    <div id="extractedInsights" style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">We detected:</div>
                                        <div id="insightsList" style="font-size: 13px; line-height: 1.6;"></div>
                                    </div>

                                    <!-- Reasoning -->
                                    <div id="recommendationReasoning" style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; backdrop-filter: blur(10px);">
                                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">Why these settings:</div>
                                        <ul id="reasoningList" style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6;"></ul>
                                    </div>

                                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                                        <button type="button" class="btn btn-sm" style="background: white; color: #667eea; flex: 1;" onclick="applyRecommendations()">
                                            ‚úì Apply These Settings
                                        </button>
                                        <button type="button" class="btn btn-sm btn-gray" onclick="dismissRecommendations()">
                                            ‚úï Dismiss
                                        </button>
                                    </div>
                                </div>

                                <!-- Loading state -->
                                <div id="prospectAnalyzing" style="display: none; margin-top: 16px; padding: 16px; background: var(--gray-50); border-radius: 8px; text-align: center;">
                                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <div style="margin-top: 8px; color: var(--gray-600); font-size: 14px;">Analyzing prospect context...</div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Duration</label>
                                <select id="durationTypeAI">
                                    <option value="7">7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30">30 days</option>
                                    <option value="indefinite">Indefinite (until stopped)</option>
                                </select>
                            </div>
                            </div>
                            <!-- END AI-POWERED MODE PANEL -->

                            <!-- QUICK SETUP MODE PANEL -->
                            <div id="quickModePanel" class="config-panel" style="display: none;">
                                <div class="form-group">
                                    <label>Industry
                                        <div class="label-description">Select the industry context for data generation</div>
                                    </label>
                                    <select id="industrySelectQuick" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
                                        <option value="finance">Finance</option>
                                        <option value="healthcare">Healthcare</option>
                                        <option value="manufacturing">Manufacturing</option>
                                        <option value="travel">Travel</option>
                                        <option value="technology" selected>Technology</option>
                                        <option value="retail">Retail</option>
                                        <option value="education">Education</option>
                                        <option value="government">Government</option>
                                        <option value="energy">Energy</option>
                                        <option value="media">Media</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Company Size
                                        <div class="label-description">Simulated organization size</div>
                                    </label>
                                    <select id="companySizeSelectQuick" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
                                        <option value="smb">SMB (1-1,000 employees)</option>
                                        <option value="mid_market" selected>Mid-Market (1,001-5,000 employees)</option>
                                        <option value="enterprise">Enterprise (5,001-10,000 employees)</option>
                                        <option value="strategic">Strategic Enterprise (10,000+ employees)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Duration</label>
                                    <select id="durationTypeQuick">
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                        <option value="indefinite">Indefinite (until stopped)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Data Volume
                                        <div class="label-description">Amount of data to generate (projects, tasks, comments, etc.)</div>
                                    </label>
                                    <div style="display: flex; align-items: center; gap: 16px; padding: 12px 0;">
                                        <span style="font-size: 13px; color: var(--gray-600); min-width: 50px;">Light</span>
                                        <input type="range" id="dataVolumeSliderQuick" min="1" max="3" value="2" step="1"
                                               style="flex: 1; height: 6px; cursor: pointer;"
                                               oninput="updateDataVolumeDisplay(this.value, 'Quick')"
                                               onchange="updateDataVolumePresets(this.value)">
                                        <span style="font-size: 13px; color: var(--gray-600); min-width: 50px; text-align: right;">Heavy</span>
                                    </div>
                                    <div id="dataVolumeLabelQuick" style="text-align: center; font-size: 14px; font-weight: 600; color: var(--primary); margin-top: 8px;">
                                        Medium
                                    </div>
                                    <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
                                        <div id="dataVolumeDescriptionQuick">
                                            Balanced data generation with realistic project and task counts
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END QUICK SETUP MODE PANEL -->

                            <!-- ADVANCED MODE PANEL -->
                            <div id="advancedModePanel" class="config-panel" style="display: none;">
                                <div class="form-group">
                                    <label>Industry
                                        <div class="label-description">Select the industry context for data generation</div>
                                    </label>
                                    <select id="industrySelectAdvanced" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
                                        <option value="finance">Finance</option>
                                        <option value="healthcare">Healthcare</option>
                                        <option value="manufacturing">Manufacturing</option>
                                        <option value="travel">Travel</option>
                                        <option value="technology" selected>Technology</option>
                                        <option value="retail">Retail</option>
                                        <option value="education">Education</option>
                                        <option value="government">Government</option>
                                        <option value="energy">Energy</option>
                                        <option value="media">Media</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Company Size
                                        <div class="label-description">Simulated organization size</div>
                                    </label>
                                    <select id="companySizeSelectAdvanced" style="width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px;">
                                        <option value="smb">SMB (1-1,000 employees)</option>
                                        <option value="mid_market" selected>Mid-Market (1,001-5,000 employees)</option>
                                        <option value="enterprise">Enterprise (5,001-10,000 employees)</option>
                                        <option value="strategic">Strategic Enterprise (10,000+ employees)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Duration</label>
                                    <select id="durationTypeAdvanced">
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                        <option value="indefinite">Indefinite (until stopped)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Data Volume
                                        <div class="label-description">Amount of data to generate (projects, tasks, comments, etc.)</div>
                                    </label>
                                    <div style="display: flex; align-items: center; gap: 16px; padding: 12px 0;">
                                        <span style="font-size: 13px; color: var(--gray-600); min-width: 50px;">Light</span>
                                        <input type="range" id="dataVolumeSliderAdvanced" min="1" max="3" value="2" step="1"
                                               style="flex: 1; height: 6px; cursor: pointer;"
                                               oninput="updateDataVolumeDisplay(this.value, 'Advanced')"
                                               onchange="updateDataVolumePresets(this.value)">
                                        <span style="font-size: 13px; color: var(--gray-600); min-width: 50px; text-align: right;">Heavy</span>
                                    </div>
                                    <div id="dataVolumeLabelAdvanced" style="text-align: center; font-size: 14px; font-weight: 600; color: var(--primary); margin-top: 8px;">
                                        Medium
                                    </div>
                                    <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: 8px; font-size: 12px; color: var(--gray-600);">
                                        <div id="dataVolumeDescriptionAdvanced">
                                            Balanced data generation with realistic project and task counts
                                        </div>
                                    </div>
                                </div>

                                <!-- Advanced Options (always visible in Advanced tab) -->
                                <div style="margin: 24px 0; padding-top: 20px; border-top: 1px solid var(--gray-200);">
                                    <div style="padding: 12px 0;">
                                        <span style="font-weight: 600; color: var(--gray-700); font-size: 15px;">Platform-Specific Settings</span>
                                    </div>

                                    <div id="advancedOptions" style="padding: 16px 0;">
                                    <!-- Asana-specific fields -->
                                    <div class="form-group asana-only">
                                        <label>Initial Projects
                                            <div class="label-description">Number of projects to create when starting</div>
                                        </label>
                                        <input type="number" id="initialProjects" value="3" min="1" max="10">
                                    </div>

                                    <!-- Okta-specific fields -->
                                    <div class="form-group okta-only" style="display: none;">
                                        <label>Initial Users
                                            <div class="label-description">Number of users to create when starting</div>
                                        </label>
                                        <input type="number" id="initialUsers" value="50" min="10" max="1000">
                                    </div>

                                    <div class="form-group okta-only" style="display: none;">
                                        <label>Organization Size
                                            <div class="label-description">Size profile affects user/group distribution</div>
                                        </label>
                                        <select id="orgSize">
                                            <option value="startup">Startup (10-50 users)</option>
                                            <option value="midsize" selected>Mid-Size (100-500 users)</option>
                                            <option value="enterprise">Enterprise (1000+ users)</option>
                                        </select>
                                    </div>

                                    <!-- Salesforce-specific fields -->
                                    <div class="form-group salesforce-only" style="display: none;">
                                        <label>Initial Accounts
                                            <div class="label-description">Number of customer accounts to create when starting</div>
                                        </label>
                                        <input type="number" id="initialAccounts" value="50" min="10" max="1000">
                                    </div>

                                    <div class="form-group salesforce-only" style="display: none;">
                                        <label>Organization Size
                                            <div class="label-description">Size profile affects account/opportunity distribution</div>
                                        </label>
                                        <select id="sfOrgSize">
                                            <option value="startup">Startup (20-150 accounts)</option>
                                            <option value="midsize" selected>Mid-Size (300-2,000 accounts)</option>
                                            <option value="enterprise">Enterprise (5,000+ accounts)</option>
                                        </select>
                                    </div>

                                    <div class="form-group salesforce-only" style="display: none;">
                                        <label>Sales Focus
                                            <div class="label-description">Primary sales motion to simulate</div>
                                        </label>
                                        <select id="salesFocus">
                                            <option value="new_business" selected>New Business - Focus on new opportunities</option>
                                            <option value="expansion">Expansion - Upsell and cross-sell existing accounts</option>
                                            <option value="balanced">Balanced - Mix of new and expansion</option>
                                        </select>
                                    </div>

                                    <div class="form-group salesforce-only" style="display: none;">
                                        <label>Case Volume
                                            <div class="label-description">Monthly support case generation rate</div>
                                        </label>
                                        <select id="caseVolume">
                                            <option value="low">Low - 5-30 cases/month</option>
                                            <option value="medium" selected>Medium - 50-300 cases/month</option>
                                            <option value="high">High - 500-5,000 cases/month</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>Activity Level
                                            <div class="label-description">Controls how frequently activity is generated</div>
                                        </label>
                                        <select id="activityLevel">
                                            <option value="low">Low - Sparse activity (~30% of medium)</option>
                                            <option value="medium" selected>Medium - Balanced, realistic activity</option>
                                            <option value="high">High - Very active team (~200% of medium)</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>Working Hours Pattern
                                            <div class="label-description">When activity should occur</div>
                                        </label>
                                        <select id="workingHours">
                                            <option value="us_workforce" selected>US Workforce (9am-6pm PT, Mon-Fri)</option>
                                            <option value="global">Global (24-hour coverage across timezones)</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>Activity Pattern
                                            <div class="label-description">How activity is distributed throughout the day</div>
                                        </label>
                                        <select id="burstFactor">
                                            <option value="0">Bursty (peaks at 9am, 1pm, 4pm)</option>
                                            <option value="0.3">Mostly Bursty</option>
                                            <option value="0.5" selected>Balanced</option>
                                            <option value="0.7">Mostly Steady</option>
                                            <option value="1">Steady (even throughout day)</option>
                                        </select>
                                    </div>

                                    <div class="form-group asana-only">
                                        <label>Task Completion Rate (% per week)
                                            <div class="label-description">What percentage of tasks get completed each week</div>
                                        </label>
                                        <input type="number" id="completionRate" value="20" min="0" max="100">
                                    </div>

                                    <div class="form-group asana-only">
                                        <label>Blocked Task Frequency (%)
                                            <div class="label-description">Percentage of tasks that become blocked</div>
                                        </label>
                                        <input type="number" id="blockedFrequency" value="15" min="0" max="100">
                                    </div>

                                    <div class="form-group asana-only">
                                        <label>Average Blocked Duration (days)
                                            <div class="label-description">How long tasks stay blocked before unblocking</div>
                                        </label>
                                        <input type="number" id="blockedDuration" value="2" min="1" max="30">
                                    </div>

                                    <div class="form-group asana-only">
                                        <label>Comment Frequency (per task per day)
                                            <div class="label-description">Average number of comments per task per day</div>
                                        </label>
                                        <input type="number" id="commentFrequency" value="0.5" min="0" max="10" step="0.1">
                                    </div>

                                    <div class="form-group asana-only">
                                        <label>New Project Frequency (days)
                                            <div class="label-description">Create new project every X days</div>
                                        </label>
                                        <input type="number" id="projectFrequency" value="14" min="1" max="90">
                                    </div>
                                </div>
                                </div>
                            </div>
                            <!-- END ADVANCED MODE PANEL -->

                            <!-- REVIEW & CONFIRM PANEL -->
                            <div id="reviewPanel" class="config-panel" style="display: none;">
                                <!-- Compact Header -->
                                <div style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 16px; border-bottom: 2px solid var(--primary-color); margin-bottom: 20px;">
                                    <div>
                                        <h4 style="margin: 0; font-size: 18px; color: var(--gray-900);">Review Configuration</h4>
                                        <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--gray-600);">Verify settings before creating your job</p>
                                    </div>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="backToConfig()">
                                        ‚úé Edit
                                    </button>
                                </div>

                                <!-- Compact Summary Table -->
                                <div style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 8px; overflow: hidden;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tbody>
                                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                                <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700); width: 35%;">Connection</td>
                                                <td style="padding: 12px 16px; color: var(--gray-900);" id="reviewConnection"></td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                                <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Job Name</td>
                                                <td style="padding: 12px 16px; color: var(--gray-900);" id="reviewJobName"></td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                                <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Duration</td>
                                                <td style="padding: 12px 16px; color: var(--gray-900);" id="reviewDuration"></td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                                <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Industry</td>
                                                <td style="padding: 12px 16px; color: var(--gray-900);" id="reviewIndustry"></td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                                <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Company Size</td>
                                                <td style="padding: 12px 16px; color: var(--gray-900);" id="reviewCompanySize"></td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                                <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Data Volume</td>
                                                <td style="padding: 12px 16px; color: var(--gray-900);" id="reviewDataVolume"></td>
                                            </tr>
                                            <!-- Platform-specific rows (dynamic) -->
                                            <tbody id="reviewPlatformRows" style="display: none;"></tbody>
                                        </tbody>
                                    </table>

                                    <!-- AI Context Section (only for AI mode) -->
                                    <div id="reviewAiSection" style="display: none; padding: 16px; border-top: 2px solid var(--gray-300); background: white;">
                                        <div style="font-weight: 500; color: var(--gray-700); margin-bottom: 8px; font-size: 13px;">AI Analysis Applied</div>
                                        <div id="reviewProspectContext" style="font-size: 13px; color: var(--gray-600); font-style: italic; margin-bottom: 12px; line-height: 1.5;"></div>
                                        <div id="reviewAiInsights" style="font-size: 12px; color: var(--gray-600); padding: 10px; background: var(--gray-50); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                            <!-- AI insights list -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div style="display: flex; gap: 12px; margin-top: 24px;">
                                    <button type="button" class="btn btn-secondary" onclick="backToConfig()" style="flex: 1;">
                                        ‚Üê Back
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="confirmAndCreateJob()" style="flex: 2;">
                                        üöÄ Create Job
                                    </button>
                                </div>
                            </div>
                            <!-- END REVIEW & CONFIRM PANEL -->

                            <button type="button" class="btn btn-primary btn-lg" id="continueToReviewBtn" onclick="proceedToReview()" style="width: 100%; margin-top: 20px;">
                                Continue to Review ‚Üí
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Initialize industry selection
            document.querySelectorAll('.industry-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.industry-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedIndustry = this.dataset.industry;
                    updateScenarios(this.dataset.industry);
                });
            });

            // CRITICAL FIX: Set selectedIndustry to match the initially selected button
            // Without this, selectedIndustry retains the value from the previous modal open
            const initiallySelected = document.querySelector('.industry-option.selected');
            if (initiallySelected) {
                selectedIndustry = initiallySelected.dataset.industry;
            }

            // Scenario selection removed - system will automatically cycle through all scenarios
        }

        // Industry use cases mapping
        const INDUSTRY_SCENARIOS = {
            healthcare: [
                { value: 'EMR System Migration', description: 'Electronic Medical Records system upgrade and data migration' },
                { value: 'New Hospital Wing Construction', description: 'Construction and setup of new patient care facility' },
                { value: 'Clinical Trial Management', description: 'Multi-site clinical research trial coordination' }
            ],
            technology: [
                { value: 'Q4 Product Launch', description: 'Major product release with new features and infrastructure' },
                { value: 'Cloud Infrastructure Migration', description: 'Migration from on-premise to cloud infrastructure' },
                { value: 'API Platform Rollout', description: 'New developer API platform and ecosystem' }
            ],
            financial_services: [
                { value: 'SOX Compliance Audit Preparation', description: 'Annual Sarbanes-Oxley compliance audit and remediation' },
                { value: 'New Banking Product Launch', description: 'Launch of new consumer banking product' },
                { value: 'Fraud Detection System Upgrade', description: 'AI-powered fraud detection implementation' }
            ],
            retail: [
                { value: 'Holiday Season Campaign', description: 'Black Friday and holiday season marketing campaign' },
                { value: 'Store Expansion Project', description: 'New retail location opening' },
                { value: 'Inventory Management System', description: 'New inventory and supply chain platform implementation' }
            ],
            construction: [
                { value: 'Commercial Building Development', description: 'Multi-tenant office building construction' },
                { value: 'Infrastructure Renovation', description: 'Major renovation of existing commercial property' }
            ],
            travel: [
                { value: 'Airport Expansion Project', description: 'Major airport terminal and runway expansion' },
                { value: 'Fleet Modernization Program', description: 'Airline fleet upgrade and aircraft acquisition' },
                { value: 'Hotel Property Opening', description: 'New hotel location launch' }
            ],
            manufacturing: [
                { value: 'Factory Automation Initiative', description: 'Implementation of robotics and automation systems' },
                { value: 'Quality Management System Certification', description: 'ISO 9001 certification and quality system overhaul' },
                { value: 'Supply Chain Optimization', description: 'End-to-end supply chain and logistics optimization' }
            ],
            education: [
                { value: 'Learning Management System Rollout', description: 'New LMS platform implementation across campus' },
                { value: 'Campus Facilities Expansion', description: 'New academic building construction and renovation' },
                { value: 'Accreditation Preparation', description: 'Multi-year accreditation review and compliance project' }
            ],
            government: [
                { value: 'Digital Services Transformation', description: 'Modernization of citizen-facing digital services' },
                { value: 'Infrastructure Improvement Project', description: 'Public infrastructure upgrade and maintenance' },
                { value: 'Emergency Response System Upgrade', description: 'Emergency services technology modernization' }
            ],
            energy: [
                { value: 'Smart Grid Implementation', description: 'Smart meter and grid modernization deployment' },
                { value: 'Renewable Energy Integration', description: 'Solar/wind farm development and grid integration' },
                { value: 'Pipeline Integrity Management', description: 'Pipeline inspection, maintenance, and safety program' }
            ],
            media: [
                { value: 'Content Production Campaign', description: 'Multi-platform content series production and launch' },
                { value: 'Streaming Platform Launch', description: 'New OTT streaming service launch' },
                { value: 'Live Event Production', description: 'Large-scale live event broadcast and production' }
            ],
            // Legacy mapping for old 'finance' industry name
            finance: []
        };

        function updateScenarios(industry) {
            const scenarioSelect = document.getElementById('scenarioSelect');
            const scenarioDescription = document.getElementById('scenarioDescription');

            // Map legacy industry names to new names
            const industryMap = {
                'finance': 'financial_services'
            };
            const mappedIndustry = industryMap[industry] || industry;

            const scenarios = INDUSTRY_SCENARIOS[mappedIndustry] || [];

            // Clear existing options
            scenarioSelect.innerHTML = '<option value="">-- Select a scenario --</option>';
            scenarioDescription.style.display = 'none';

            if (scenarios.length > 0) {
                // Add scenario options
                scenarios.forEach(scenario => {
                    const option = document.createElement('option');
                    option.value = scenario.value;
                    option.textContent = scenario.value;
                    option.dataset.description = scenario.description;
                    scenarioSelect.appendChild(option);
                });

                // Select first scenario by default
                scenarioSelect.selectedIndex = 1;
                updateScenarioDescription(scenarios[0].value);
            } else {
                // No specific scenarios - add a generic option
                const option = document.createElement('option');
                option.value = 'random';
                option.textContent = 'Random Project (Legacy Mode)';
                option.dataset.description = 'AI will generate a random project for this industry';
                scenarioSelect.appendChild(option);
                scenarioSelect.selectedIndex = 1;
                updateScenarioDescription('random');
            }
        }

        function updateScenarioDescription(scenarioValue) {
            const scenarioSelect = document.getElementById('scenarioSelect');
            const scenarioDescription = document.getElementById('scenarioDescription');

            if (!scenarioValue) {
                scenarioDescription.style.display = 'none';
                return;
            }

            const selectedOption = scenarioSelect.options[scenarioSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.description) {
                scenarioDescription.style.display = 'block';
                scenarioDescription.textContent = selectedOption.dataset.description;
            } else {
                scenarioDescription.style.display = 'none';
            }
        }

        // ============================================================================
        // PROSPECT CONTEXT ANALYSIS FUNCTIONS
        // ============================================================================

        // Global variable to store prospect analysis results
        let prospectAnalysisData = null;

        /**
         * Update the prospect context placeholder based on selected platform
         */
        function updateProspectContextPlaceholder(platform) {
            const textarea = document.getElementById('prospectContext');
            const label = document.getElementById('prospectContextLabel');

            if (!textarea || !label) return;

            const placeholders = {
                'asana': 'Tell us about your prospect: company size, industry, project management challenges, team structure, collaboration needs, etc.',
                'salesforce': 'Tell us about your prospect: company size, industry, sales process complexity, deal sizes, sales cycle, pipeline management needs, etc.',
                'okta': 'Tell us about your prospect: company size, industry, user management needs, application portfolio, security requirements, compliance needs, etc.'
            };

            const exampleTexts = {
                'asana': 'e.g., Mid-size healthcare provider with 500 employees, managing complex patient care workflows across 3 hospital locations. Heavy regulatory compliance requirements and need for cross-departmental collaboration.',
                'salesforce': 'e.g., Enterprise software company with 2,000 employees, selling to Fortune 500 accounts with $500K+ deal sizes and 6-9 month sales cycles. Complex account hierarchies and strong territory management needs.',
                'okta': 'e.g., Financial services firm with 1,200 employees across 5 offices. High security requirements, strict compliance (SOC2, HIPAA), managing 50+ SaaS applications with complex user provisioning workflows.'
            };

            label.textContent = placeholders[platform] || placeholders['asana'];
            textarea.placeholder = exampleTexts[platform] || exampleTexts['asana'];
        }

        /**
         * Analyze prospect context using the API
         */
        async function analyzeProspectContext() {
            const prospectText = document.getElementById('prospectContext').value.trim();
            const connectionId = document.getElementById('connectionSelect').value;
            const settings = loadSettings();

            if (!prospectText) {
                showToast('Please enter prospect context first', 'error');
                return;
            }

            if (!connectionId) {
                showToast('Please select a connection first', 'error');
                return;
            }

            // Get connection details
            const connections = loadConnections();
            const connection = connections.find(c => c.id === connectionId);

            if (!connection) {
                showToast('Invalid connection selected', 'error');
                return;
            }

            const platform = connection.vendor;

            // Show loading state
            document.getElementById('prospectAnalyzing').style.display = 'block';
            document.getElementById('prospectRecommendations').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;

            try {
                const response = await fetch('/api/prospect-context/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prospect_text: prospectText,
                        platform: platform,
                        connection_name: connection.name,
                        anthropic_api_key: settings.anthropicKey
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to analyze prospect context');
                }

                // Store the analysis data globally
                prospectAnalysisData = result;

                // Display recommendations
                displayRecommendations(result.extracted_context, result.recommendations);

                showToast('Prospect context analyzed successfully!', 'success');

            } catch (error) {
                console.error('Error analyzing prospect context:', error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                document.getElementById('prospectAnalyzing').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        /**
         * Display recommendations in the UI
         */
        function displayRecommendations(extractedContext, recommendations) {
            const recommendationsDiv = document.getElementById('prospectRecommendations');
            const insightsList = document.getElementById('insightsList');
            const reasoningList = document.getElementById('reasoningList');

            // Build insights summary
            const insights = [];
            if (extractedContext.industry) {
                insights.push(`<strong>Industry:</strong> ${extractedContext.industry.charAt(0).toUpperCase() + extractedContext.industry.slice(1)}`);
            }
            if (extractedContext.company_size) {
                // Use the label from backend if available, otherwise use the raw value
                const sizeDisplay = extractedContext.company_size_label || extractedContext.company_size;
                insights.push(`<strong>Company Size:</strong> ${sizeDisplay}`);
            }
            if (extractedContext.org_complexity) {
                insights.push(`<strong>Complexity:</strong> ${extractedContext.org_complexity.charAt(0).toUpperCase() + extractedContext.org_complexity.slice(1)}`);
            }
            if (extractedContext.key_insights && extractedContext.key_insights.length > 0) {
                extractedContext.key_insights.forEach(insight => {
                    if (insight !== "Using default settings") {
                        insights.push(`‚Ä¢ ${insight}`);
                    }
                });
            }

            insightsList.innerHTML = insights.join('<br>');

            // Build reasoning list
            if (recommendations.reasoning && recommendations.reasoning.length > 0) {
                reasoningList.innerHTML = recommendations.reasoning
                    .map(reason => `<li>${reason}</li>`)
                    .join('');
            } else {
                reasoningList.innerHTML = '<li>Using balanced default settings</li>';
            }

            // Show recommendations
            recommendationsDiv.style.display = 'block';

            // Scroll to recommendations
            recommendationsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        /**
         * Apply recommendations to the form
         */
        function applyRecommendations() {
            if (!prospectAnalysisData) {
                showToast('No recommendations to apply', 'error');
                return;
            }

            const recommendations = prospectAnalysisData.recommendations;
            const extractedContext = prospectAnalysisData.extracted_context;

            // In AI mode, recommendations are automatically used when creating the job
            // The prospectAnalysisData is already stored globally and will be used by createJob()
            // Just acknowledge that the recommendations are ready

            // Hide recommendations and show success
            document.getElementById('prospectRecommendations').style.display = 'none';
            showToast('Recommendations ready! Click "Start Continuous Generation" to create the job.', 'success');
        }

        /**
         * Dismiss recommendations without applying
         */
        function dismissRecommendations() {
            document.getElementById('prospectRecommendations').style.display = 'none';
        }

        /**
         * Skip the prospect context step
         */
        function skipProspectContext() {
            document.getElementById('prospectContext').value = '';
            prospectAnalysisData = null;
            document.getElementById('prospectRecommendations').style.display = 'none';
            showToast('Prospect context skipped', 'info');
        }

        // ============================================================================
        // END PROSPECT CONTEXT FUNCTIONS
        // ============================================================================

        // ============================================================================
        // CONFIGURATION MODE SWITCHING
        // ============================================================================

        /**
         * Switch between AI-Powered, Quick Setup, and Advanced configuration modes
         */
        function switchConfigMode(event, mode) {
            // Update tab buttons
            document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.mode-tab').classList.add('active');

            // Show/hide panels
            document.getElementById('aiModePanel').style.display = mode === 'ai' ? 'block' : 'none';
            document.getElementById('quickModePanel').style.display = mode === 'quick' ? 'block' : 'none';
            document.getElementById('advancedModePanel').style.display = mode === 'advanced' ? 'block' : 'none';
        }

        // ============================================================================
        // END CONFIGURATION MODE SWITCHING
        // ============================================================================

        // ============================================================================
        // REVIEW & CONFIRM FLOW
        // ============================================================================

        let currentConfigMode = 'ai'; // Track which mode user configured

        /**
         * Proceed to review panel
         */
        function proceedToReview() {
            // Determine current mode
            if (document.getElementById('aiModePanel').style.display !== 'none') currentConfigMode = 'ai';
            else if (document.getElementById('quickModePanel').style.display !== 'none') currentConfigMode = 'quick';
            else currentConfigMode = 'advanced';

            // Validate required fields first
            const connectionId = document.getElementById('connectionSelect')?.value;
            const jobName = document.getElementById('jobName')?.value?.trim();

            if (!connectionId) {
                showToast('Please select a connection first', 'error');
                return;
            }

            if (!jobName) {
                showToast('Please enter a job name', 'error');
                return;
            }

            // Build summary data
            buildReviewSummary(currentConfigMode);

            // Hide all config panels
            document.getElementById('aiModePanel').style.display = 'none';
            document.getElementById('quickModePanel').style.display = 'none';
            document.getElementById('advancedModePanel').style.display = 'none';

            // Hide continue button
            document.getElementById('continueToReviewBtn').style.display = 'none';

            // Show review panel
            document.getElementById('reviewPanel').style.display = 'block';

            // Scroll to top of modal
            const modal = document.querySelector('.modal');
            if (modal) modal.scrollTop = 0;
        }

        /**
         * Build review summary
         */
        function buildReviewSummary(mode) {
            const connections = loadConnections();
            const connectionId = document.getElementById('connectionSelect')?.value;
            const connection = connections.find(c => c.id === connectionId);

            // Basic info
            document.getElementById('reviewConnection').textContent = connection?.name || 'Unknown';
            document.getElementById('reviewJobName').textContent = document.getElementById('jobName').value;

            // Duration
            let durationElement;
            if (mode === 'ai') durationElement = document.getElementById('durationTypeAI');
            else if (mode === 'quick') durationElement = document.getElementById('durationTypeQuick');
            else durationElement = document.getElementById('durationTypeAdvanced');

            const durationValue = durationElement?.value || '14';
            const durationText = durationValue === 'indefinite' ? 'Indefinite (until stopped)' : `${durationValue} days`;
            document.getElementById('reviewDuration').textContent = durationText;

            // Industry & Company Size & Data Volume
            let industry, companySize, dataVolume;

            if (mode === 'ai') {
                // From AI recommendations
                industry = prospectAnalysisData?.recommendations?.industry || 'Technology';
                companySize = prospectAnalysisData?.extracted_context?.company_size_label || 'SMB (1-1,000 employees)';
                const volLevel = prospectAnalysisData?.recommendations?.data_volume || 'medium';
                dataVolume = volLevel.charAt(0).toUpperCase() + volLevel.slice(1);
            } else {
                // From manual selection
                const industrySelect = mode === 'quick' ?
                    document.getElementById('industrySelectQuick') :
                    document.getElementById('industrySelectAdvanced');
                industry = industrySelect?.options[industrySelect.selectedIndex]?.text || 'Technology';

                const sizeSelect = mode === 'quick' ?
                    document.getElementById('companySizeSelectQuick') :
                    document.getElementById('companySizeSelectAdvanced');
                companySize = sizeSelect?.options[sizeSelect.selectedIndex]?.text || 'SMB (1-1,000 employees)';

                const volSlider = mode === 'quick' ?
                    document.getElementById('dataVolumeSliderQuick') :
                    document.getElementById('dataVolumeSliderAdvanced');
                const volValue = parseInt(volSlider?.value || '2');
                dataVolume = volValue === 1 ? 'Light' : volValue === 3 ? 'Heavy' : 'Medium';
            }

            document.getElementById('reviewIndustry').textContent = industry;
            document.getElementById('reviewCompanySize').textContent = companySize;
            document.getElementById('reviewDataVolume').textContent = dataVolume;

            // Platform-specific settings (show only in advanced mode)
            const platformRows = document.getElementById('reviewPlatformRows');
            if (mode === 'advanced') {
                platformRows.style.display = 'table-row-group';
                buildPlatformReview(connection.vendor);
            } else {
                platformRows.style.display = 'none';
            }

            // AI Section (show only in AI mode)
            if (mode === 'ai') {
                document.getElementById('reviewAiSection').style.display = 'block';
                const prospectText = document.getElementById('prospectContext').value.trim();
                document.getElementById('reviewProspectContext').textContent =
                    prospectText.length > 150 ? prospectText.substring(0, 150) + '...' : prospectText;

                // Show AI insights
                if (prospectAnalysisData?.extracted_context?.key_insights) {
                    const insightsHtml = prospectAnalysisData.extracted_context.key_insights
                        .map(insight => `<div style="padding: 3px 0;">‚Ä¢ ${insight}</div>`)
                        .join('');
                    document.getElementById('reviewAiInsights').innerHTML = insightsHtml;
                }
            } else {
                document.getElementById('reviewAiSection').style.display = 'none';
            }
        }

        /**
         * Build platform-specific review section as table rows
         */
        function buildPlatformReview(platform) {
            const platformRows = document.getElementById('reviewPlatformRows');
            let html = '';

            if (platform === 'asana') {
                const initialProjects = document.getElementById('initialProjects')?.value || '3';
                const activityLevel = document.getElementById('activityLevel')?.value || 'medium';
                html = `
                    <tr style="border-bottom: 1px solid var(--gray-200);">
                        <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Initial Projects</td>
                        <td style="padding: 12px 16px; color: var(--gray-900);">${initialProjects}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--gray-200);">
                        <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Activity Level</td>
                        <td style="padding: 12px 16px; color: var(--gray-900);">${activityLevel.charAt(0).toUpperCase() + activityLevel.slice(1)}</td>
                    </tr>
                `;
            } else if (platform === 'okta') {
                const initialUsers = document.getElementById('initialUsers')?.value || '100';
                html = `
                    <tr style="border-bottom: 1px solid var(--gray-200);">
                        <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Initial Users</td>
                        <td style="padding: 12px 16px; color: var(--gray-900);">${initialUsers}</td>
                    </tr>
                `;
            } else if (platform === 'salesforce') {
                const initialAccounts = document.getElementById('initialAccounts')?.value || '50';
                const salesFocus = document.getElementById('salesFocus')?.value || 'balanced';
                html = `
                    <tr style="border-bottom: 1px solid var(--gray-200);">
                        <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Initial Accounts</td>
                        <td style="padding: 12px 16px; color: var(--gray-900);">${initialAccounts}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--gray-200);">
                        <td style="padding: 12px 16px; font-weight: 500; color: var(--gray-700);">Sales Focus</td>
                        <td style="padding: 12px 16px; color: var(--gray-900);">${salesFocus.charAt(0).toUpperCase() + salesFocus.slice(1)}</td>
                    </tr>
                `;
            }

            platformRows.innerHTML = html;
        }

        /**
         * Edit a specific section
         */
        function editSection(section) {
            // Hide review panel
            document.getElementById('reviewPanel').style.display = 'none';

            // Show continue button
            document.getElementById('continueToReviewBtn').style.display = 'block';

            // Show the appropriate config panel
            if (section === 'basic' || section === 'config') {
                // Show the config panel for current mode
                if (currentConfigMode === 'ai') {
                    document.getElementById('aiModePanel').style.display = 'block';
                } else if (currentConfigMode === 'quick') {
                    document.getElementById('quickModePanel').style.display = 'block';
                } else {
                    document.getElementById('advancedModePanel').style.display = 'block';
                }
            } else if (section === 'ai') {
                document.getElementById('aiModePanel').style.display = 'block';
                currentConfigMode = 'ai';
            } else if (section === 'advanced') {
                document.getElementById('advancedModePanel').style.display = 'block';
                currentConfigMode = 'advanced';
            }

            // Scroll to top
            const modal = document.querySelector('.modal');
            if (modal) modal.scrollTop = 0;
        }

        /**
         * Back to config from review
         */
        function backToConfig() {
            editSection('config');
        }

        /**
         * Confirm and create job (final step)
         */
        function confirmAndCreateJob() {
            // Create a synthetic event object
            const form = document.getElementById('newJobForm');
            const syntheticEvent = {
                preventDefault: () => {},
                target: form
            };

            // Call the existing createJob function
            createJob(syntheticEvent);
        }

        // ============================================================================
        // END REVIEW & CONFIRM FLOW
        // ============================================================================

        function updateConnectionInfo() {
            const connectionId = document.getElementById('connectionSelect').value;
            const infoDiv = document.getElementById('connectionInfo');

            if (!connectionId) {
                infoDiv.style.display = 'none';
                // Hide all connection-specific fields
                document.querySelectorAll('.asana-only').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.okta-only').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.salesforce-only').forEach(el => el.style.display = 'none');
                return;
            }

            const connections = loadConnections();
            const connection = connections.find(c => c.id === connectionId);

            if (connection) {
                const connectionType = connection.vendor || 'asana';

                // Build tenant info based on platform
                let tenantLabel = 'Tenant';
                let tenantValue = '';

                if (connectionType === 'asana') {
                    tenantLabel = 'Workspace';
                    tenantValue = connection.workspaceGid;
                } else if (connectionType === 'okta') {
                    tenantLabel = 'Organization';
                    tenantValue = connection.orgUrl;
                } else if (connectionType === 'salesforce') {
                    tenantLabel = 'Instance';
                    tenantValue = connection.instanceUrl;
                }

                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                    <div style="margin-bottom: 8px;"><strong>Platform:</strong> ${connection.vendor.charAt(0).toUpperCase() + connection.vendor.slice(1)}</div>
                    <div style="margin-bottom: 8px;"><strong>${tenantLabel}:</strong> ${tenantValue}</div>
                    <div><strong>Users:</strong> ${connection.users.map(u => u.name).join(', ')}</div>
                `;

                // Show/hide connection-specific fields based on connection type
                if (connectionType === 'asana') {
                    document.querySelectorAll('.asana-only').forEach(el => el.style.display = 'block');
                    document.querySelectorAll('.okta-only').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.salesforce-only').forEach(el => el.style.display = 'none');
                } else if (connectionType === 'okta') {
                    document.querySelectorAll('.asana-only').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.okta-only').forEach(el => el.style.display = 'block');
                    document.querySelectorAll('.salesforce-only').forEach(el => el.style.display = 'none');
                } else if (connectionType === 'salesforce') {
                    document.querySelectorAll('.asana-only').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.okta-only').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.salesforce-only').forEach(el => el.style.display = 'block');
                } else {
                    // Default to asana if unknown
                    document.querySelectorAll('.asana-only').forEach(el => el.style.display = 'block');
                    document.querySelectorAll('.okta-only').forEach(el => el.style.display = 'none');
                    document.querySelectorAll('.salesforce-only').forEach(el => el.style.display = 'none');
                }

                // Update prospect context placeholder based on selected platform
                updateProspectContextPlaceholder(connectionType);
            }
        }

        function updateVendorFields() {
            const vendor = document.getElementById('vendorSelect').value;
            // Currently only Asana is supported
            // In the future, this function will show/hide vendor-specific fields
            if (vendor !== 'asana') {
                showToast('This platform is not yet supported. Only Asana is available.', 'error');
            }
        }

        function toggleAdvancedOptions() {
            const options = document.getElementById('advancedOptions');
            const chevron = document.getElementById('advancedChevron');

            if (options.style.display === 'none') {
                options.style.display = 'block';
                chevron.style.transform = 'rotate(90deg)';
            } else {
                options.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function updateDataVolumeDisplay(value, modeSuffix = '') {
            const label = document.getElementById('dataVolumeLabel' + modeSuffix);
            const description = document.getElementById('dataVolumeDescription' + modeSuffix);

            const presets = {
                '1': {
                    name: 'Light',
                    description: 'Minimal data generation - Good for testing and small demos (1-2 projects, few tasks)'
                },
                '2': {
                    name: 'Medium',
                    description: 'Balanced data generation with realistic project and task counts'
                },
                '3': {
                    name: 'Heavy',
                    description: 'Large-scale data generation - Comprehensive demos with many projects and activities'
                }
            };

            if (label && description && presets[value]) {
                label.textContent = presets[value].name;
                description.textContent = presets[value].description;
            }
        }

        function updateDataVolumePresets(value) {
            // Preset configurations for each volume level
            const presets = {
                '1': {  // Light
                    initialProjects: 1,
                    activityLevel: 'low',
                    completionRate: 10,
                    blockedFrequency: 5,
                    blockedDuration: 1,
                    commentFrequency: 0.2,
                    projectFrequency: 30
                },
                '2': {  // Medium (default)
                    initialProjects: 3,
                    activityLevel: 'medium',
                    completionRate: 20,
                    blockedFrequency: 15,
                    blockedDuration: 2,
                    commentFrequency: 0.5,
                    projectFrequency: 14
                },
                '3': {  // Heavy
                    initialProjects: 8,
                    activityLevel: 'high',
                    completionRate: 30,
                    blockedFrequency: 20,
                    blockedDuration: 3,
                    commentFrequency: 1.5,
                    projectFrequency: 7
                }
            };

            const preset = presets[value];

            // Update all advanced option fields
            document.getElementById('initialProjects').value = preset.initialProjects;
            document.getElementById('activityLevel').value = preset.activityLevel;
            document.getElementById('completionRate').value = preset.completionRate;
            document.getElementById('blockedFrequency').value = preset.blockedFrequency;
            document.getElementById('blockedDuration').value = preset.blockedDuration;
            document.getElementById('commentFrequency').value = preset.commentFrequency;
            document.getElementById('projectFrequency').value = preset.projectFrequency;
        }

        function addUserToken() {
            const container = document.getElementById('userTokensContainer');
            const newItem = document.createElement('div');
            newItem.className = 'user-token-item';
            newItem.innerHTML = `
                <input type="text" placeholder="User name (e.g. Bob)" class="user-name" required>
                <input type="password" placeholder="Asana Personal Access Token" class="user-token" required>
                <button type="button" class="remove-user-btn" onclick="removeUserToken(this)">√ó</button>
            `;
            container.appendChild(newItem);
        }

        function removeUserToken(button) {
            const container = document.getElementById('userTokensContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showToast('You must have at least one user token', 'error');
            }
        }

        async function createJob(e) {
            e.preventDefault();

            // Find the Create Job button in the review panel
            const submitBtn = document.querySelector('#reviewPanel button[onclick="confirmAndCreateJob()"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Starting...';
            }

            try {
                // Load settings
                const settings = loadSettings();
                if (!settings.anthropicKey) {
                    throw new Error('Anthropic API key not configured. Please go to Settings.');
                }

                // Get selected connection
                const connectionId = document.getElementById('connectionSelect').value;
                if (!connectionId) {
                    throw new Error('Please select a connection');
                }

                const connections = loadConnections();
                const connection = connections.find(c => c.id === connectionId);

                if (!connection) {
                    throw new Error('Selected connection not found');
                }

                // Prepare user tokens from connection - platform-specific structure
                let userTokens;
                const connectionType = connection.vendor || 'asana';

                if (connectionType === 'salesforce') {
                    // Salesforce uses full credential structure
                    userTokens = connection.users.map(user => ({
                        name: user.name,
                        username: user.username,
                        password: user.password,
                        security_token: user.security_token,
                        instance_url: user.instance_url
                    }));
                } else if (connectionType === 'okta') {
                    // Okta uses token + org_url
                    userTokens = connection.users.map(user => ({
                        name: user.name,
                        token: user.token,
                        org_url: user.org_url
                    }));
                } else {
                    // Asana uses simple name + token
                    userTokens = connection.users.map(user => ({
                        name: user.name,
                        token: user.token
                    }));
                }

                // Use the currentConfigMode variable set by review flow
                const mode = currentConfigMode;
                const aiModeActive = mode === 'ai';
                const quickModeActive = mode === 'quick';
                const advancedModeActive = mode === 'advanced';

                // Get duration based on active mode
                let durationType;
                if (aiModeActive) {
                    durationType = document.getElementById('durationTypeAI').value;
                } else if (quickModeActive) {
                    durationType = document.getElementById('durationTypeQuick').value;
                } else {
                    durationType = document.getElementById('durationTypeAdvanced').value;
                }

                // Get advanced options (with defaults)
                const getAdvancedValue = (id, defaultValue) => {
                    const element = document.getElementById(id);
                    return element ? element.value : defaultValue;
                };

                // Map legacy industry names to template names
                const industryMap = {
                    'finance': 'financial_services'
                };

                // Get industry based on active mode
                let selectedIndustry;
                if (aiModeActive) {
                    // AI mode doesn't need industry selection - it's extracted from prospect context
                    // Default to technology if no recommendations applied
                    selectedIndustry = prospectAnalysisData?.recommendations?.industry || 'technology';
                } else if (quickModeActive) {
                    selectedIndustry = document.getElementById('industrySelectQuick').value;
                } else {
                    selectedIndustry = document.getElementById('industrySelectAdvanced').value;
                }

                const mappedIndustry = industryMap[selectedIndustry] || selectedIndustry;

                // Build base configuration using connection and settings
                const config = {
                    connection_type: connectionType,
                    vendor: connection.vendor,
                    industry: mappedIndustry,
                    workspace_name: connection.name || `${selectedIndustry.charAt(0).toUpperCase() + selectedIndustry.slice(1)} Demo`,
                    job_name: document.getElementById('jobName').value.trim() || null,
                    duration_days: durationType === 'indefinite' ? 'indefinite' : parseInt(durationType),
                    activity_level: getAdvancedValue('activityLevel', 'medium'),
                    working_hours: getAdvancedValue('workingHours', 'us_workforce'),
                    burst_factor: parseFloat(getAdvancedValue('burstFactor', 0.5)),
                    privacy: 'private',
                    user_tokens: userTokens,
                    anthropic_api_key: settings.anthropicKey
                };

                // Add platform-specific tenant identifier
                if (connectionType === 'asana') {
                    config.workspace_gid = connection.workspaceGid;
                } else if (connectionType === 'okta') {
                    config.org_url = connection.orgUrl;
                } else if (connectionType === 'salesforce') {
                    config.instance_url = connection.instanceUrl;
                }

                // Get company size if in Quick or Advanced mode
                let companySize = 'mid_market'; // default
                if (quickModeActive) {
                    companySize = document.getElementById('companySizeSelectQuick').value;
                } else if (advancedModeActive) {
                    companySize = document.getElementById('companySizeSelectAdvanced').value;
                }

                // Map company size to platform-specific initial values
                const companySizePresets = {
                    'smb': { asana: 2, okta: 50, salesforce: 30, orgSize: 'startup' },
                    'mid_market': { asana: 3, okta: 200, salesforce: 100, orgSize: 'midsize' },
                    'enterprise': { asana: 5, okta: 1000, salesforce: 500, orgSize: 'enterprise' },
                    'strategic': { asana: 8, okta: 5000, salesforce: 2000, orgSize: 'enterprise' }
                };

                // Add connection-specific fields
                if (connectionType === 'asana') {
                    if (advancedModeActive) {
                        // Use advanced fields if in Advanced mode
                        config.initial_projects = parseInt(getAdvancedValue('initialProjects', 3));
                        config.task_completion_rate = parseInt(getAdvancedValue('completionRate', 20));
                        config.blocked_task_frequency = parseInt(getAdvancedValue('blockedFrequency', 15));
                        config.blocked_task_duration = parseInt(getAdvancedValue('blockedDuration', 2));
                        config.comment_frequency = parseFloat(getAdvancedValue('commentFrequency', 0.5));
                        config.new_project_frequency_days = parseInt(getAdvancedValue('projectFrequency', 14));
                    } else if (aiModeActive && prospectAnalysisData?.recommendations) {
                        // Use AI recommendations if available
                        const rec = prospectAnalysisData.recommendations;
                        config.initial_projects = rec.initial_projects || 3;
                        config.task_completion_rate = rec.task_completion_rate || 20;
                        config.blocked_task_frequency = rec.blocked_task_frequency || 15;
                        config.blocked_task_duration = rec.blocked_task_duration || 2;
                        config.comment_frequency = rec.comment_frequency || 0.5;
                        config.new_project_frequency_days = rec.project_frequency || 14;
                    } else {
                        // Use company size preset for Quick mode
                        config.initial_projects = companySizePresets[companySize].asana;
                        config.task_completion_rate = 20;
                        config.blocked_task_frequency = 15;
                        config.blocked_task_duration = 2;
                        config.comment_frequency = 0.5;
                        config.new_project_frequency_days = 14;
                    }
                } else if (connectionType === 'okta') {
                    if (advancedModeActive) {
                        // Use advanced fields if in Advanced mode
                        config.initial_users = parseInt(getAdvancedValue('initialUsers', 50));
                        config.org_size = getAdvancedValue('orgSize', 'midsize');
                    } else if (aiModeActive && prospectAnalysisData?.recommendations) {
                        // Use AI recommendations if available
                        const rec = prospectAnalysisData.recommendations;
                        config.initial_users = rec.initial_users || 50;
                        config.org_size = rec.org_size || 'midsize';
                    } else {
                        // Use company size preset for Quick mode
                        config.initial_users = companySizePresets[companySize].okta;
                        config.org_size = companySizePresets[companySize].orgSize;
                    }
                } else if (connectionType === 'salesforce') {
                    if (advancedModeActive) {
                        // Use advanced fields if in Advanced mode
                        config.initial_accounts = parseInt(getAdvancedValue('initialAccounts', 50));
                        config.org_size = getAdvancedValue('sfOrgSize', 'midsize');
                        config.sales_focus = getAdvancedValue('salesFocus', 'new_business');
                        config.case_volume = getAdvancedValue('caseVolume', 'medium');
                    } else if (aiModeActive && prospectAnalysisData?.recommendations) {
                        // Use AI recommendations if available
                        const rec = prospectAnalysisData.recommendations;
                        config.initial_accounts = rec.initial_accounts || 50;
                        config.org_size = rec.org_size || 'midsize';
                        config.sales_focus = rec.sales_focus || 'balanced';
                        config.case_volume = rec.case_volume || 'medium';
                    } else {
                        // Use company size preset for Quick mode
                        config.initial_accounts = companySizePresets[companySize].salesforce;
                        config.org_size = companySizePresets[companySize].orgSize;
                        config.sales_focus = 'balanced';
                        config.case_volume = 'medium';
                    }
                }

                // Apply AI recommendations for activity settings if in AI mode
                if (aiModeActive && prospectAnalysisData?.recommendations) {
                    const rec = prospectAnalysisData.recommendations;
                    if (rec.activity_level) config.activity_level = rec.activity_level;
                    if (rec.working_hours) config.working_hours = rec.working_hours;
                    if (rec.burst_factor !== undefined) config.burst_factor = parseFloat(rec.burst_factor);
                }

                // Add prospect context data if available
                const prospectText = document.getElementById('prospectContext')?.value.trim();
                if (prospectText) {
                    config.prospect_context = {
                        raw_text: prospectText,
                        analyzed_at: new Date().toISOString()
                    };

                    // If we have analysis data, include it
                    if (prospectAnalysisData) {
                        config.prospect_context.extracted_context = prospectAnalysisData.extracted_context;
                        config.prospect_context.recommendations = prospectAnalysisData.recommendations;
                    }
                }

                // Start job
                const response = await fetch(`${API_BASE}/jobs/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`Job created successfully! Job ID: ${data.job_id}`, 'success');
                    document.querySelector('.modal-backdrop').remove();

                    // Navigate to jobs view
                    document.querySelector('.nav-item[data-view="jobs"]').click();
                } else {
                    throw new Error(data.error || 'Failed to start job');
                }

            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üöÄ Create Job';
                }
            }
        }

        async function pauseJob(jobId) {
            if (!confirm('Pause this job?')) return;
            await jobAction(jobId, 'pause');
        }

        async function resumeJob(jobId) {
            await jobAction(jobId, 'resume');
        }

        async function stopJob(jobId) {
            if (!confirm('Stop this job? You can resume it later to continue where it left off.')) return;
            await jobAction(jobId, 'stop');
        }

        async function deleteJob(jobId, connectionType = 'asana') {
            console.log('deleteJob called for job:', jobId, 'connectionType:', connectionType);

            // Platform-specific messaging
            const platformName = connectionType.charAt(0).toUpperCase() + connectionType.slice(1);
            let dataDescription = '';

            if (connectionType === 'asana') {
                dataDescription = 'all projects, tasks, and comments in Asana';
            } else if (connectionType === 'okta') {
                dataDescription = 'all users, groups, and app assignments in Okta';
            } else if (connectionType === 'salesforce') {
                dataDescription = 'all accounts, contacts, opportunities, leads, cases, and campaigns in Salesforce';
            } else {
                dataDescription = `all ${platformName} data`;
            }

            // First confirmation - Do they want to cleanup platform data?
            const cleanupPlatform = confirm(
                `Do you want to delete ALL ${platformName} data created by this job?\n\n` +
                `‚Ä¢ YES: Will delete ${dataDescription}\n` +
                `‚Ä¢ NO: Will only delete the job record (${platformName} data remains)\n\n` +
                `Click OK to DELETE ${platformName} data, or Cancel to keep it.`
            );

            console.log('cleanupPlatform:', cleanupPlatform);

            // Second confirmation - Final warning
            if (!confirm(`‚ö†Ô∏è FINAL CONFIRMATION ‚ö†Ô∏è\n\n${cleanupPlatform ? `This will PERMANENTLY DELETE all ${platformName} data created by this job AND the job record.` : `This will delete the job record only. ${platformName} data will remain.`}\n\nThis action cannot be undone. Continue?`)) {
                console.log('User cancelled final confirmation');
                return;
            }

            try {
                // If user wants to cleanup platform data, do that first
                if (cleanupPlatform) {
                    console.log('Starting cleanup...');
                    showToast(`Cleaning up ${platformName} data... This may take a moment.`, 'info');

                    const cleanupResponse = await fetch(`${API_BASE}/jobs/${jobId}/cleanup`, {
                        method: 'POST'
                    });

                    console.log('Cleanup response status:', cleanupResponse.status);

                    let cleanupData;
                    try {
                        const cleanupText = await cleanupResponse.text();
                        console.log('Cleanup response text:', cleanupText);
                        cleanupData = JSON.parse(cleanupText);
                    } catch (parseError) {
                        console.error('Failed to parse cleanup response:', parseError);
                        throw new Error('Invalid response from cleanup endpoint');
                    }

                    if (!cleanupData.success) {
                        // Construct error message from platform-specific failed items
                        let errorMsg = cleanupData.error;

                        // Handle Asana-specific failures
                        if (!errorMsg && cleanupData.failed_projects && cleanupData.failed_projects.length > 0) {
                            errorMsg = `Failed to delete ${cleanupData.failed_projects.length} project(s):\n`;
                            errorMsg += cleanupData.failed_projects.map(p => `  ‚Ä¢ ${p.name || p.id}`).join('\n');
                            errorMsg += '\n\n(Projects may have already been deleted)';
                        }

                        if (!errorMsg) {
                            errorMsg = 'Unknown error during cleanup';
                        }

                        if (!confirm(`‚ö†Ô∏è Cleanup encountered errors:\n\n${errorMsg}\n\nDo you want to continue deleting the job anyway?`)) {
                            console.log('User cancelled after cleanup error');
                            return;
                        }
                    } else {
                        // Platform-specific success messages
                        let successMsg = '';
                        if (connectionType === 'asana') {
                            successMsg = `Cleanup complete: ${cleanupData.deleted_projects}/${cleanupData.total_projects} projects deleted`;
                        } else if (connectionType === 'okta') {
                            const total = (cleanupData.users_deleted || 0) + (cleanupData.groups_deleted || 0) + (cleanupData.assignments_removed || 0);
                            successMsg = `Cleanup complete: ${cleanupData.users_deleted || 0} users, ${cleanupData.groups_deleted || 0} groups deleted`;
                        } else if (connectionType === 'salesforce') {
                            const total = (cleanupData.accounts_deleted || 0) + (cleanupData.opportunities_deleted || 0) + (cleanupData.contacts_deleted || 0);
                            successMsg = `Cleanup complete: ${cleanupData.accounts_deleted || 0} accounts, ${cleanupData.opportunities_deleted || 0} opportunities, ${cleanupData.contacts_deleted || 0} contacts deleted`;
                        } else {
                            successMsg = 'Cleanup complete';
                        }
                        showToast(successMsg, 'success');

                        // Check if any failures occurred (Asana-specific)
                        if (cleanupData.failed_projects && cleanupData.failed_projects.length > 0) {
                            const failedNames = cleanupData.failed_projects.map(p => p.name).join(', ');
                            showToast(`‚ö†Ô∏è Failed to delete: ${failedNames}`, 'warning');
                        }
                    }
                }

                // Now delete the job record
                console.log('Deleting job record...');
                const deleteUrl = `${API_BASE}/jobs/${jobId}/delete`;
                console.log('DELETE URL:', deleteUrl);

                const response = await fetch(deleteUrl, {
                    method: 'DELETE'
                });

                console.log('Delete response status:', response.status, 'ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete failed:', response.status, errorText);
                    throw new Error(`Server returned ${response.status}: ${errorText || 'No error message'}`);
                }

                let data;
                try {
                    const responseText = await response.text();
                    console.log('Delete response text:', responseText);
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse delete response:', parseError);
                    throw new Error('Invalid response from delete endpoint');
                }

                console.log('Delete response data:', data);

                if (data.success) {
                    showToast('Job deleted successfully', 'success');
                    refreshData();
                } else {
                    throw new Error(data.error || 'Failed to delete job');
                }
            } catch (error) {
                console.error('Delete error (full):', error);
                console.error('Error type:', typeof error);
                console.error('Error message:', error?.message);
                console.error('Error stack:', error?.stack);

                const errorMessage = error?.message || (typeof error === 'string' ? error : 'Failed to delete job');
                showToast(`Error: ${errorMessage}`, 'error');
            }
        }

        async function jobAction(jobId, action) {
            try {
                const response = await fetch(`${API_BASE}/jobs/${jobId}/${action}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    // Properly format the past tense of the action
                    const actionPastTense = action === 'stop' ? 'stopped' :
                                          action === 'pause' ? 'paused' :
                                          action === 'resume' ? 'resumed' :
                                          `${action}ed`;
                    showToast(`Job ${actionPastTense} successfully`, 'success');
                    refreshData();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function generateNow(jobId) {
            try {
                showToast('Generating activity now...', 'info');
                const response = await fetch(`${API_BASE}/jobs/${jobId}/generate-now`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('Activity generated successfully!', 'success');
                    // Refresh after a short delay to show new activity
                    setTimeout(() => refreshData(), 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function viewActivityLog(jobId) {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">Activity Log - Job ${jobId}</h2>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">√ó</button>
                    </div>
                    <div class="modal-body" id="activityLogBody">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading activity log...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            try {
                const response = await fetch(`${API_BASE}/jobs/${jobId}/activity_log?limit=100`);
                const data = await response.json();

                const logBody = document.getElementById('activityLogBody');

                if (data.success && data.activities.length > 0) {
                    let html = '<div class="activity-log">';

                    data.activities.forEach(activity => {
                        const timestamp = new Date(activity.timestamp);
                        const {action, details, user} = formatActivity(activity);

                        html += `
                            <div class="activity-item">
                                <div class="activity-time">${timestamp.toLocaleString()}</div>
                                ${user ? `
                                    <div class="activity-user">
                                        <div class="activity-user-badge">${user}</div>
                                    </div>
                                ` : ''}
                                <div class="activity-details">
                                    <div class="activity-action">${action}</div>
                                    <div class="activity-description">${details}</div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    logBody.innerHTML = html;
                } else {
                    logBody.innerHTML = '<div class="empty-state"><div class="empty-state-text">No activity yet</div></div>';
                }
            } catch (error) {
                document.getElementById('activityLogBody').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Error: ${error.message}</div>
                    </div>
                `;
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function formatScheduledTime(date) {
            const now = new Date();
            const diffMs = date - now;
            const diffMins = Math.floor(diffMs / 1000 / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            let timeUntil = '';
            if (diffMs < 0) {
                timeUntil = 'Overdue - generating now';
            } else if (diffMins < 1) {
                timeUntil = 'Within 1 minute';
            } else if (diffMins < 60) {
                timeUntil = `in ${diffMins} minute${diffMins !== 1 ? 's' : ''}`;
            } else if (diffHours < 24) {
                timeUntil = `in ${diffHours} hour${diffHours !== 1 ? 's' : ''}`;
            } else {
                timeUntil = `in ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
            }

            return `${date.toLocaleString()} (${timeUntil})`;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>
